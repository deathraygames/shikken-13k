!function(){function o(e="U"){return[e,F(9999).toString(36),Number(new Date).toString(36)].join("-")}function t(){return 1+T.s.reduce((e,t)=>e+(L[T.g[t].type].I||0),0)}function i(e,t,n={}){var r=e<t;if(e={key:o("R"),from:r?e:t,R:r?t:e,...n},T.J[e.key])throw Error("Existing building");T.J[e.key]=e,T.P.push(e.key)}function a(e,t=0){var n=L[e.type]["rate"];n?(t=Number.isNaN(t)?0:t,e.V=1/n*6e4+t,e.B=e.V):e.B=0}function u(e={},t=null){if(a(e={key:o("B"),type:"connector",B:0,V:1,$:!0,resources:["wood","stone","wood","grain"],refresh:!1,x:F(1e3),y:F(1e3),...e}),T.g[e.key])throw Error("Existing building");return console.log("Adding building",e),T.g[e.key]=e,T.s.push(e.key),t&&i(e.key,t),e}function n(e={}){if(T.o.length>=t())return console.warn("Could not add another meeple"),0;if(e={key:o("M"),m:"idle",oa:100,ea:null,ta:null,da:null,path:[],x:F(1e3),y:F(1e3),...e},T.v[e.key])throw Error("Existing meeple");return console.log("Adding meeple",e),T.v[e.key]=e,T.o.push(e.key),e}function e(){return D.reduce((e,t)=>({...e,[t]:0}),{})}function l(){return T.o.reduce((e,t)=>(e[(t=T.v[t]).m]=(e[t.m]||0)+1,e),e())}function r(t={}){const n=e(),r=e=>(n[e]||0)<t[e];T.o.forEach(e=>{e=T.v[e],r(e.m)||(e.m=D.find(r)||"idle",e.path=[]),e=e.m,n[e]=(n[e]||0)+1}),console.log("Meeples assigned jobs:",T.v,"desired:",t,"final:",n)}function s(){const i=T.K.U;T.s.forEach(e=>{var t,n,r=T.g[e],o=document.getElementById(e);o&&r.refresh&&(o.remove(),o=null,r.refresh=!1),o||(o=L[r.type],(t=I("g",i.S)).id=r.key,n=I("circle",t),S(n,{cx:r.x,cy:r.y,r:o.r,T:"building b-"+r.type}),o=t),r.resources.forEach(()=>{}),o.classList.toggle("selectedb",e===T.l)})}function c(n){D.forEach(e=>{var t=document.querySelector("#jr-"+e);n(e,t.querySelector('input[type="range"]'),t,t.querySelector("b"))})}function d(){var o,i,a;T.D&&(o=l(),i=T.o.length,a=Math.min(i,T.s.reduce((e,t)=>e+(L[T.g[t].type].F||0),0)),c((e,t,n,r)=>{n=o[e],r.innerText=n,t.max!==(e="defe"===e?a:i)&&(t.setAttribute("max",e),t.max=e),t.value!==n&&(t.setAttribute("value",n),t.value=n)}))}function h(){(t=document.querySelector("main").classList).toggle("bselected",T.l),t.toggle("looping",T.H),t.toggle("creating",T.u),t.toggle("assigning",T.D),t.toggle("pop",0<T.o.length),T.M||(T.M=document.getElementById("cd"));var e=T.L,t=Math.floor(1/60*e*.001),e=Math.floor(.001*(e-6e4*t));T.M.innerText=t+":"+(e<10?"0":"")+e,T.l&&(t=L[T.g[T.l].type]["A"],A("#blist",t?t.map(e=>{var{name:t=e,i:n}=L[e];return`<li class=up-action data-upgrade="${e}" data-building="${T.l}">
						<span class=up-name>${t}</span>
						<span class=up-cost>${n}</span>
					</li>`}).join(""):"No upgrades"))}function y(){var r,e=T.K;e.O.style.top=e.y+"px",e.O.style.left=e.x+"px",r=e.U,s(),T.P.forEach(e=>{var t,n=T.J[e];document.getElementById(e)||((e=I("line",r.aa)).id=n.key,t=T.g[n.from],n=T.g[n.R],S(e,{x1:t.x,y1:t.y,x2:n.x,y2:n.y,T:"road"}))}),T.o.forEach(e=>{var t=T.v[e];(e=document.getElementById(e))||((e=I("circle",r.Z)).id=t.key,S(e,{cx:0,cy:0,r:7,T:"meeple mj-"+t.m})),e.setAttribute("class","meeple mj-"+t.m),e.style.cx=t.x,e.style.cy=t.y}),h()}function p(n){let r=1/0,o=null;var e,i,a;return e=T.s,i=T.g,a=e=>{var t=N(e).N(n);t>=r||(r=t,o=e)},e.map((e,t)=>a(i[e],e,t)),o}function m(e=[],n){const r="string"==typeof e?[e]:[...e];if(20<=r.length||r.includes(n))return r;var o;if(o=r[r.length-1],(e=T.P.reduce((e,t)=>((t=T.J[t]).from===o?e.push(t.R):t.R===o&&e.push(t.from),e),[])).includes(n))return r.concat(n);let i=1/0,a=null;return e=e.map(e=>{let t=[...r];return r.includes(e)||(t.push(e),(t=m(t,n)).includes(n)&&t.length<=i&&(a=t,i=t.length)),t}),null===a?e[0]:a}function g(e,t){return(t=p(t))?m([t.key],e.key).map(e=>{var t=T.g[e];return{key:e,x:t.x,y:t.y}}):[]}function f(e){var t=L[e.type];return(t.input&&t.input.length||t.j&&t.j.length)&&e.$}function x(e,t){var n,r=p(e);return!(!(n=!r||(n=L[r.type],N(r).N(e)>n.r)?null:r)||t&&t.key!==n.key)&&(t=f(n),"prod"===e.m)&&t}function v(n){return T.o.reduce((e,t)=>e+(x(T.v[t],n)?1:0),0)}function w(e,t=[]){return 0===e.resources.reduce((e,t)=>(0<=(t=e.indexOf(t))&&e.splice(t,1),e),[...t]).length}function k(t,n=[]){if(!n.length)return!0;if(!w(t,n))return!1;n=[...n];for(let e=t.resources.length;e--;e){var r=n.indexOf(t.resources[e]);0<=r&&(n.splice(r,1),t.resources.splice(e,1))}return 0===n.length}function b(e,t=[]){return t.includes("meeple")?n({x:e.x,y:e.y}):!(e.resources.length>=L[e.type].r/2)&&(e.resources=e.resources.concat([...t]),1)}function E(e,t,n,r){r*=n,n=N(e),t=N(t).ba(n).W(r),t=n.add(t),e.x=t.x,e.y=t.y}function C(e,t){e.path.length&&X(e,e.path[0])&&e.path.shift(),e.path.length?E(e,e.path[0],t,.07):(t=(t=T.s)[F(t.length)],console.log("Pick random building",t),void 0!==t&&(e.path=g(T.g[t],e)))}function H(e,t){var n,r;e.path.length&&X(e,e.path[0])&&e.path.shift(),e.path.length?E(e,e.path[0],t,.07):x(e)?(r=t,(n=e).x+=(r=r*(.14*.75)*.25)*(2*(0|$(2))-1),n.y+=r*(2*(0|$(2))-1)):(t=(t=T.s.filter(e=>f(T.g[e])))[F(t.length)],console.log("Pick random production building",t),void 0!==t&&(e.path=g(T.g[t],e)))}function O(){var e,t,r;T.H&&(e=Number(new Date),t=T.G?e-T.G:0,T.G=e,T.L-=t,r=t,T.o.forEach(e=>{var t={C:C,qa:H};t[(e=T.v[e]).m]&&t[e.m](e,r)}),T.s.forEach(e=>{e=T.g[e];var t,n=L[e.type];(n.j||n.input)&&(t=Math.min(v(e),n.h),e.B-=r*(t?t/t**.55:0),0<e.B||(e.B=0,k(e,n.input)&&(b(e,n.j)?a(e,e.B):b(e,n.input))))}),y(),setTimeout(O,100))}function P(){T.H=!0,T.G=0,O()}function q(){T.H=!1}function R(e){T.l=e.key;var t=L[e.type];return`<div class=b-name>${t.name||e.type}</div>
		<div>Resources: ${e.resources.join(", ")}</div>
		<div>Production: ${t.input.join(", ")} ➡️ ${t.j.join(", ")} ##%</div>
		Upgrades:`}function G(e){var t=e.target,n=t.classList;let r="";n.contains("building")?(e=T.g[t.closest("g").id],T.u&&T.l&&(i(e.key,T.l),T.u=!1),r=R(e)):T.u&&T.l?(T.u=!1,e=u({x:e.clientX,y:e.clientY,type:"connector"},T.l),r=R(e)):(T.l=null,n.contains("road")&&(r="road")),A("#binfo",r),y()}function K(n,r={}){const o=n.target;Object.keys(r).forEach(e=>{var t=o.closest(e);t&&r[e](n,t)}),h()}function U(e){K(e,{".up-action":(e,t)=>{e=t.dataset.upgrade,t=T.g[t.dataset.S];var{A:n=[]}=L[t.type];if(!n.includes(e))throw Error("Unknown upTypeKey");t.type=e,t.refresh=!0,a(t),s(),T.u=!1}})}function J(e){K(e,{"#play":P,"#pause":q,"#build":()=>T.u=!0,"#cancel":()=>T.u=!1,"#restart":()=>window.location.reload(),"#jobs":()=>{T.D=!T.D,d()}})}function W(t){var e=t.O;let n;B(e,"dragstart",e=>{e.dataTransfer.setData("text/plain","w"),e.dataTransfer.effectAllowed="move",n=e}),B(e,"drop",e=>{t.x+=e.clientX-n.clientX,t.y+=e.clientY-n.clientY,y()}),B(document.querySelector("main"),"dragover",e=>{e.preventDefault()}),e.addEventListener("pointerdown",G),B(document.getElementById("bui"),"pointerdown",J),B(document.getElementById("tui"),"pointerdown",U),c((t,n)=>{B(n,"change",()=>{var e=function(r,e){const o=l(),i={...o,[r]:e};if((e=i[r]-o[r])<=0)i.C+=-1*e;else{let n=e;if("idle"!==r&&(e=Math.min(o.C,e),n-=e,i.C-=e),!(n<=0)){const a=D.reduce((e,t)=>(t!==r&&"idle"!==t&&e.push(t),e),[]);a.forEach((e,t)=>{t=Math.min(Math.ceil(n/(a.length-t||1)),o[e]),n-=t,i[e]-=t})}}return i}(t,Number(n.value)||0);console.log("Desiring",e),r(e),d(),y()})})}const j=window.ja?(...e)=>console.assert(...e):()=>{};class M{constructor(e=0,t=0){this.x=e,this.y=t}add(e){return j(null!=e.x),new M(this.x+e.x,this.y+e.y)}ba(e){return j(null!=e.x),new M(this.x-e.x,this.y-e.y)}multiply(e){return j(null!=e.x),new M(this.x*e.x,this.y*e.y)}scale(e){return j(null==e.x),new M(this.x*e,this.y*e)}length(){return this.Y()**.5}Y(){return this.x**2+this.y**2}N(e){return this.X(e)**.5}X(e){return(this.x-e.x)**2+(this.y-e.y)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new M(0,e)}W(e=1){var t=this.length();return e<t?this.scale(e/t):this}angle(){return Math.atan2(this.x,this.y)}rotate(e){var t=Math.cos(e);return e=Math.sin(e),new M(this.x*t-this.y*e,this.x*e+this.y*t)}direction(){return abs(this.x)>abs(this.y)?this.x<0?3:1:this.y<0?2:0}floor(){return new M(Math.floor(this.x),Math.floor(this.y))}toString(e=3){return`(${(this.x<0?"":" ")+this.x.toFixed(e)},${(this.y<0?"":" ")+this.y.toFixed(e)} )`}}const B=(e,t,n)=>e.addEventListener(t,n),I=(e,t)=>(e=document.createElementNS("http://www.w3.org/2000/svg",e),t.appendChild(e),e),S=(t,n)=>Object.keys(n).forEach(e=>t.setAttribute(e,n[e])),A=(e,t)=>(e=document.querySelector(e)).innerHTML!==t&&(e.innerHTML=t,!0),$=(e=1,t=0)=>t+(e-t)*Math.random(),F=(e=1,t=0)=>0|$(e,t),N=(e=0,t)=>null==e.x?new M(e,null==t?e:t):new M(e.x,e.y),X=(e,t,n=2)=>N(e).N(t)<=n,D=["idle","prod","carr","defe","spir"],Y=["Wanderer (Idle)","Farmer/Artisan (Production)","Peasant (Carrying)","Samurai (Defenders)","Monk/Pilgrim (Spiritualist)"],V={name:"",r:10,h:0,i:[],A:[],F:0,I:0,input:[],j:[],rate:0},L=[{key:"outpost",name:"Outpost",r:20,h:19,i:["wood","wood","stone","stone"],F:2,I:10},{key:"connector",r:10,h:4,i:["stone"],A:"stoneMine grainFarm tower shrine farmHouse woodCutter stockpile".split(" ")},{key:"stockpile",name:"Stockpile",r:40,h:20,i:["stone","wood"]},{key:"woodCutter",name:"Woodcutter",r:20,h:6,i:["wood"],input:[],j:["wood"],rate:2},{key:"stoneMine",name:"Stone Mine",r:20,h:6,i:["wood"],input:[],j:["wood"],rate:2,A:["oreMine"]},{key:"oreMine",name:"Ore Mine",r:30,h:6,i:["wood"],input:[],j:["ore"],rate:2},{key:"tower",name:"Watchtower",r:14,h:2,i:["stone","wood","wood"],F:5,A:["fortress"]},{key:"fortress",name:"Fortress",r:24,h:4,i:["stone","stone","stone","stone","wood"],F:8},{key:"grainFarm",name:"Grain farm",r:20,h:10,i:["wood","wood"],input:[],j:["grain"],rate:2,A:["riceFarm"]},{key:"riceFarm",name:"Rice farm",r:24,h:6,i:["wood"],input:[],j:["rice"],rate:2},{key:"shrine",name:"Shrine",r:16,h:6,i:["wood"],input:["rice"],j:["karma"],rate:2,A:["temple"]},{key:"temple",name:"Temple",r:32,h:6,i:["wood"],input:["rice"],j:["karma","karma"],rate:2},{key:"farmHouse",name:"Noka (farmhouse)",r:20,h:6,i:["wood"],input:["grain"],j:["meeple"],rate:10,I:4,A:["urbanHouse"]},{key:"urbanHouse",name:"Machiya (urban house)",r:30,h:6,i:["wood"],input:["rice"],j:["meeple"],rate:1,I:8}].reduce((e,t)=>(e[t.key]={...V,...t},e),{}),T=window.ka={state:"game",K:{},g:{},s:[],v:{},o:[],J:{},P:[],l:null,M:null,G:0,L:3e5,H:!1,u:!1,D:!1,start:function(){console.log("hello shikken");var e=document.getElementById("wc"),t=document.getElementById("w");T.K={c:e,O:t,sa:document.getElementById("ws"),ha:e.getContext("2d"),U:{aa:document.getElementById("layer-road"),S:document.getElementById("layer-building"),ra:document.getElementById("layer-resource"),Z:document.getElementById("layer-meeple")},x:0,y:0},A("#jass",`<ul>${D.map((e,t)=>`<li id=jr-${e}><label for="input-${e}">${Y[t]}</label><b></b>
		<input id="input-${e}" type=range min=0></li>`).join("")}</ul>`),W(T.K),e=u({type:"connector"}),u({type:"connector"},e.key),n(),n(),n(),y()},la:l,ca:r,ma:m,ia:w,fa:k,pa:x,ga:v,na:t};document.addEventListener("DOMContentLoaded",T.start)}();