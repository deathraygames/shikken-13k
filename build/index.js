!function(){function i(){return{x:N(H.world.width/2),y:N(H.world.height)}}function r(e="U"){return[e,N(9999).toString(36),Number(new Date).toString(36)].join("-")}function s(e,n,i){e.map((e,t)=>i(n[e],e,t))}function o(){return 1+H.buildingKeys.reduce((e,t)=>e+(A[H.buildings[t].type].popMax||0),0)}function l(){return H.buildingKeys.reduce((e,t)=>e+(A[H.buildings[t].type].defMax||0),0)}function c(e,t,n={}){var i=e<t;if(e={key:r("R"),from:i?e:t,to:i?t:e,...n},H.roads[e.key])throw Error("Existing building");H.roads[e.key]=e,H.roadKeys.push(e.key)}function u(e,t=0){var n=A[e.type]["rate"];n?(t=Number.isNaN(t)?0:t,e.prodHeat=1/n*6e4+t,H.godMode&&(e.prodHeat=1),e.prodCool=e.prodHeat):e.prodCool=0}function d(e={},t=null){if(u(e={key:r("B"),type:"connector",supplied:!1,prodCool:0,prodHeat:0,on:!0,inv:[],refresh:!1,...i(),...e}),H.buildings[e.key])throw Error("Existing building");return console.log("Adding building",e),H.buildings[e.key]=e,H.buildingKeys.push(e.key),t&&c(e.key,t),e}function T(e={},t){var n;if([n={}]=[e],e={key:r("M"),job:"idle",faction:"japan",hp:100,defense:.5,carry:null,weapon:null,buildingKey:null,path:[],inv:[],...i(),...n},H.meeples[e.key])throw Error("Existing meeple");return console.log("Adding meeple",e),H.meeples[e.key]=e,t.push(e.key),e}function p(e={}){return!(H.citizenKeys.length>=o())&&T(e,H.citizenKeys)}function I(){return L.reduce((e,t)=>({...e,[t]:0}),{})}function W(){return H.citizenKeys.reduce((e,t)=>(e[(t=H.meeples[t]).job]=(e[t.job]||0)+1,e),I())}function F(e){var t=A[e.type].r+4,n=0===e.prodHeat?0:1-e.prodCool/e.prodHeat,e=(e=document.getElementById(e.key)).querySelector(".b-prod-circle");if(!e)throw Error("No circle element");var i=2*t*Math.PI;n*=i,z(e,{r:t,"stroke-width":"10","stroke-dasharray":[n,i-n].join(" "),"stroke-dashoffset":40})}function D(e,t){var{shape:n,sides:i,r,offsetAngle:o=0}=xe[e],n=(t=S(n,t),function(t,n,i=0){var r=[];for(let e=0;e<t;e+=1){var o=i+e/t*j,{x:o,y:a}=C().setAngle(o,n);r.push([o,a].map(e=>Math.round(100*e)/100))}return r}(i,r,o).map(e=>e.join(",")).join(" "));return z(t,{points:n,r:r,class:"res res-"+e,"data-res":e}),t}function P(e,n,i=10){const t=[...n.children],r=[...e];t.forEach(e=>{var t=e.dataset["res"];!t||-1===(t=r.indexOf(t))?e.remove():r.splice(t,1)}),r.forEach(e=>{e=D(e,n);var t=C(0,0).setAngle(O(2*Math.PI),O(i));e.style.cx=t.x,e.style.cy=t.y,e.style.transform=B(t)})}function Y(){const o=H.world["layers"];s(H.buildingKeys,H.buildings,e=>{var t,n,i=A[e.type],r=document.getElementById(e.key);r&&e.refresh&&(r.remove(),r=null,e.refresh=!1),r||(t=A[e.type],r=S("g",o.building),z(r,{id:e.key,style:"transform: "+B(e)}),n=S("circle",r),z(n,{class:"b-prod-circle b-prod-"+e.type}),F(e),n=S("circle",r),z(n,{r:t.r,class:"building b-"+e.type}),t=S("g",r),z(t,{class:"b-res-g res-g"})),r.classList.toggle("closed",!e.on),r.classList.toggle("selectedb",e.key===H.selectedBuildingKey),F(e),P(e.inv,r.querySelector(".res-g"),i.r)})}function R(e,t){var n=document.getElementById(e.key);n||(n=S("g",t),z(n,{id:e.key,style:"transform: "+B(e),class:"meeple-g"}),t=S("circle",n),z(t,{r:9,class:"meeple mj-"+e.job}),t=S("g",n),z(t,{class:"m-res-g res-g"})),t=n.querySelector(".meeple"),z(t,{class:"meeple mj-"+e.job}),n.classList.toggle("hurt",e.hp<100),n.style.transform=B(e),P(e.inv,n.querySelector(".res-g"),9)}function X(r){L.forEach(e=>{var t=document.querySelector("#jr-"+e),n=t.querySelector('input[type="range"]'),i=t.querySelector(".jr-num");r(e,n,t,i)})}function U(){var r,o,a;H.assigning&&(r=W(),o=H.citizenKeys.length,a=Math.min(o,l()),X((e,t,n,i)=>{n=r[e],i.innerText=n,t.max!==(e="defe"===e?a:o)&&(t.setAttribute("max",e),t.max=e),t.value!==n&&(t.setAttribute("value",n),t.value=n)}))}function G(){(r=document.querySelector("main").classList).toggle("bselected",H.selectedBuildingKey),r.toggle("looping",H.looping),r.toggle("creating",H.creating),r.toggle("moving",H.moving),r.toggle("assigning",H.assigning),r.toggle("pop",0<H.citizenKeys.length),r.toggle("intro","intro"===H.state),r.toggle("game","game"===H.state),r.toggle("flash",H.flashMessage),H.countdownEl||(H.countdownEl=document.getElementById("cd"));var e,t,n,i=H.countdown,r=Math.floor(1/60*i*.001),i=Math.floor(.001*(i-6e4*r));q(H.countdownEl,`${H.peace?"‚òÆÔ∏è":"‚öîÔ∏è"} ${r}:`+(i<10?"0":"")+i),q("#karma",H.karma?`ü™∑ Karma: ${H.karma} /300`:""),document.querySelector("#kamikaze").style.display=300<=H.karma?"block":"none",H.selectedBuildingKey&&(r=H.buildings[H.selectedBuildingKey],(i=r)&&(t=A[i.type],e=`<div class="switch">
		<button ${i.on?'disabled="disabled"':' id="b-on"'}><i>üïØÔ∏è</i><b>On</b></button>
		<button ${i.on?'id="b-off"':'disabled="disabled"'}><i>üö´</i><b>Off</b></button>
	</div>`,n=`<div>ü™ö Production:
			<span class="prodin ${i.supplied?"supplied":"missing"}">
				${t.input.length?t.input.join(", "):"(No input)"}
			</span>
			‚û°Ô∏è ${t.output.length?t.output.join(", "):"(No output)"}
			<span>(${t.rate}/min)</span>
			<span id="b-progress">%</span>
		</div>`,t=`<div>
			<div class="b-name">${t.classification} ${t.name||i.type}</div>
			<div>üì¶ Resources: ${i.inv.join(", ")} (${i.inv.length} / max: ${t.cap})</div>
			${h(i)?n:""}
			${t.popMax?`<div>+${t.popMax} max citizens</div>`:""}
			${t.defMax?`<div>+${t.defMax} max defenders</div>`:""}
		</div>
		<div>
			${e}
		</div>`,q("#binfo",t),h(i))&&(t=Math.floor(100*(0===i.prodHeat?0:1-i.prodCool/i.prodHeat)),q("#b-progress",f(i)?t+"%":"")),r=A[r.type]["upgrades"],r=r.length?r.map(e=>{var{name:t=e,cost:n,classification:i}=A[e];return`<li class="up-action ${Q(n)?"affordable":"unaffordable"}" data-upgrade="${e}" data-building="${H.selectedBuildingKey}">
					<span class="up-name">${i} ${t}</span>
					<span class="up-cost">${n}</span>
				</li>`}).join(""):"No upgrades",q("#blist",H.upgradesOpen?r:"")),n=`${H.citizenKeys.length} / max: ${o()}, Defenders max: `+l(),q("#mcounts",n)}function g(){var i,e=H.world,t=(e.el.style.top=e.y+"px",e.el.style.left=e.x+"px",H.world.height*H.zoom);e.el.style.width=H.world.width*H.zoom+"px",e.el.style.height=t+"px",i=e.layers,Y(),s(H.roadKeys,H.roads,e=>{var t,n;document.getElementById(e.key)||((t=S("line",i.road)).id=e.key,n=H.buildings[e.from],e=H.buildings[e.to],z(t,{x1:n.x,y1:n.y,x2:e.x,y2:e.y,class:"road"}))}),s(H.citizenKeys,H.meeples,e=>R(e,i.meeple)),s(H.invaderKeys,H.meeples,e=>R(e,i.meeple)),G()}function t(e,t,n){H.flashMessage={title:e,text:t,emoji:n},q("#flash i",n),q("#flash h1",e),q("#flash p",t),g(),fe()}function J(e=[]){const t=function(){const t={},e=e=>{e.inv.forEach(e=>{t[e]=(t[e]||0)+1})};return s(H.buildingKeys,H.buildings,e),s(H.citizenKeys,H.meeples,e),t}(),n=e.reduce((e,t)=>({...e,[t]:(e[t]||0)+1}),{}),i={};return Object.keys(n).forEach(e=>{i[e]=n[e]-(t[e]||0),i[e]<0&&(i[e]=0)}),i}function Q(e=[]){const n=J(e);return Object.keys(n).reduce((e,t)=>e+n[t],0)<=0}function a(t){return H.buildingKeys.filter(e=>(e=H.buildings[e],t(e,A[e.type])))}function V(n){let i=1/0,r=null;return s(H.buildingKeys,H.buildings,e=>{var t=C(e).distance(n);t>=i||(i=t,r=e)}),r}function Z(e,t){var n=A[t.type];return C(t).distance(e)<=n.r}function y(e){var t,n=V(e);return!n||(t=A[n.type],C(n).distance(e)>t.r)?null:n}function _(e=[],n){const i="string"==typeof e?[e]:[...e];if(20<=i.length||i.includes(n))return i;var r;if(r=i[i.length-1],(e=H.roadKeys.reduce((e,t)=>((t=H.roads[t]).from===r?e.push(t.to):t.to===r&&e.push(t.from),e),[])).includes(n))return i.concat(n);let o=1/0,a=null;return e=e.map(e=>{let t=[...i];return i.includes(e)||(t.push(e),(t=_(t,n)).includes(n)&&t.length<=o&&(a=t,o=t.length)),t}),null===a?e[0]:a}function h(e){return(e=A[e.type]).input&&e.input.length||e.output&&e.output.length}function f(e){return h(e)&&e.on}function m(e,t){var n=y(e);return n&&(!t||t.key===n.key)&&(t=f(n),n=A[n.type],t)&&("prod"===e.job&&"ü™ö"===n.classification||"spir"===e.job&&"ü™∑"===n.classification)}function ee(e){if(!e.on)return[...e.inv];const i=[...A[e.type].input];return e.inv.reduce((e,t)=>{var n=i.indexOf(t);return 0<n?i.splice(n,1):e.push(t),e},[])}function v(e){return e.inv.length>=A[e.type].cap}function te(e,t=[]){let n=1/0,i=null;const r=C(e);return t.forEach(e=>{e=H.meeples[e];var t=r.distance(e);t>=n||(n=t,i=e)}),{nearest:i,distance:n}}function ne(e){var t=H.citizenKeys.indexOf(e.key);-1!==t&&H.citizenKeys.splice(t,1),-1!==(t=H.invaderKeys.indexOf(e.key))&&H.invaderKeys.splice(t,1),delete H.meeples[e.key],document.getElementById(e.key).remove()}function ie(e,t){var n=t/2;e.hp-=t+N(n)-N(n)}function b(e,t=[],n=!1){{if(t.length){if(n&&([n,a=[]]=[e.inv,t],0!==n.reduce((e,t)=>(0<=(t=e.indexOf(t))&&e.splice(t,1),e),[...a]).length))return[...t];var[i,r=[]]=[e.inv,t];if(!r.length)return[];r=[...r];for(let e=i.length;e--;e){var o=r.indexOf(i[e]);0<=o&&(r.splice(o,1),i.splice(e,1))}return r}return[]}var a}function re(e,t){return!(!e.inv.length||!Z(e,t)||(e=e.inv.shift(),t.inv.push(e),0))}function w(e){return!!(e.path.length&&(n=(t=e).path[0],i=2,C(t).distance(n)<=i))&&(e.path.shift(),!0);var t,n,i}function oe(e,t,n){var i=C(t),{x:n,y:t}=(n&&(t=C(e),i=(i=i.subtract(t)).clampLength(n),i=t.add(i)),i);e.path=[{x:n,y:t}]}function x(e,t){void 0!==(t=(t=(t="string"==typeof t?[t]:t).length?t:H.buildingKeys)[N(t.length)])&&(e.path=(t=H.buildings[t],(e=V(e=e))?_([e.key],t.key).map(e=>{var t=H.buildings[e];return{key:e,x:t.x,y:t.y}}):[]))}function k(e,t,n,i){i*=n,n=C(e),t=C(t).subtract(n).clampLength(i),t=n.add(t),e.x=t.x,e.y=t.y}function ae(e,t){e.x+=(t*=.0225)*(2*(0|O(2))-1),e.y+=t*(2*(0|O(2))-1)}function K(e){var t;return e.inv.length&&(t=y(e))?{b:t,dropped:e=re(e,t)}:{}}function M(e,t){return!H.invaderKeys.length&&e.hp<100&&(e.hp=Math.min(100,e.hp+.005*t),1)}function se(e,t){w(e),e.path.length?M(e,t)||k(e,e.path[0],t,.03):(K(e),x(e,H.buildingKeys))}function le(e,t){w(e),e.path.length?M(e,t)||k(e,e.path[0],t,.12):(K(e),(m(e)?ae:(t=a((e,t)=>f(e)&&"ü™ö"===t.classification),x))(e,t))}function ce(o,e){var t,n,i,r=w(o);if(o.path.length)M(o,e)||k(o,o.path[0],e,.132*(o.inv.length?.6:1));else{if(e=[],e=y(o),o.inv.length){if(r&&e)return void re(o,e);0===(e=a(e=>{return t=e,n=o.inv[0],!!t.on&&(i=(e,t)=>e+(t===n?1:0),r=A[t.type].input.reduce(i,0),(t=t.inv.reduce(i,0))<r)&&!v(e);var t,n,i,r})).length&&(e=a((e,t)=>"üì¶"===t.classification&&!v(e)&&e.on))}else{if(r&&e)return r=e,void(0<(t=o).inv.length||!Z(t,r)||!(i=ee(r)).length||0<b(r,[n=n&&i.includes(n)?n:i[N(i.length)]],!0).length||t.inv.push(n));e=a(e=>(e=ee(e))&&e.length)}x(o,e)}}function ue(e,t){var n;w(e),e.path.length?M(e,t)||k(e,e.path[0],t,.12):(t=K(e)["b"],t&&"üõ°Ô∏è"===A[t.type].classification&&(e.defense=Math.min(e.defense+.01,.9)),0<H.invaderKeys.length?oe(e,t=H.meeples[(n=H.invaderKeys)[N(n.length)]],90):x(e,t=a((e,t)=>"üõ°Ô∏è"===t.classification)))}function de(e,t){w(e),e.path.length?M(e,t)||k(e,e.path[0],t,.12):(m(e)?ae:(t=a((e,t)=>f(e)&&"ü™∑"===t.classification),x))(e,t)}function pe(e,t){w(e);var n=y(e);n&&(u(n),O()<.5)&&n.inv.length&&n.inv.pop(),e.path.length?k(e,e.path[0],t,.12):(t=H.citizenKeys,n=H.meeples[t[N(t.length)]],O()<.3&&(t=te(e,t)["nearest"],n=t),oe(e,n,180))}function ge(s){var e=e=>{var t;(e=H.meeples[e]).hp<=0?ne(e):(t={idle:se,prod:le,carr:ce,defe:ue,spir:de,kill:pe})[e.job]&&t[e.job](e,s)};H.citizenKeys.forEach(e),H.invaderKeys.forEach(e),H.buildingKeys.forEach(e=>{e=H.buildings[e];var t,n,i,r,o,a=A[e.type];(a.output||a.input)&&e.on&&(a.input.length||(e.supplied=!0),e.supplied?(t=Math.min((o=e,H.citizenKeys.reduce((e,t)=>e+(m(H.meeples[t],o)?1:0),0)),6),n=a.autoWork?1:0,e.prodCool-=s*(t?t/t**.55:n),0<e.prodCool||(e.prodCool=0,[t,n=[]]=[e,a.output],(n.includes("meeple")?({x:i,y:r}=t,p({x:i,y:r})):n.includes("karma")?(n.forEach(e=>{"karma"===e&&(H.karma+=1)}),1):!v(t)&&(t.inv=t.inv.concat([...n]),1))&&(e.supplied=!1,u(e,e.prodCool)))):0<b(e,a.input,!0).length||(e.supplied=!0))});{const i=H.citizenKeys;H.invaderKeys.forEach(e=>{var{nearest:t,distance:n}=te(e=H.meeples[e],i);n<=13.5&&(O()>e.defense&&ie(e,20),O()>t.defense)&&ie(t,20)})}}function ye(){if(H.looping){var t=Number(new Date),e=H.lastTime?t-H.lastTime:0;if(H.lastTime=t,H.peace)H.countdown=0;else if(H.countdown-=e,H.countdown<=0){t=H.citizenKeys.length;for(let e=0;e<t;e+=1)T({key:r("I"),job:"kill",faction:"mongol",hp:100,defense:.2,x:0,...void 0},H.invaderKeys);H.countdown=24e4}ge(e),g(),setTimeout(ye,100)}}function he(){H.looping=!0,H.lastTime=0,ye()}function fe(){H.looping=!1}function me(n,i={}){const r=n.target;Object.keys(i).forEach(e=>{var t=r.closest(e);t&&i[e](n,t)}),G()}function ve(e){me(e,{".up-action":(e,t)=>{var{building:n,upgrade:i}=t.dataset;if(e=H.buildings[n],{upgrades:t=[]}=A[e.type],!t.includes(i))throw Error("Unknown upTypeKey");!function(e,n=[]){if(Q(n)){let t=[...n];return t=b(e,t),s(H.buildingKeys,H.buildings,e=>{t=b(e,t)}),s(H.citizenKeys,H.meeples,e=>{t=b(e,t)}),1}}(e,A[i].cost)||(e.type=i,e.refresh=!0,u(e),Y()),H.creating=!1},"#b-on":()=>H.buildings[H.selectedBuildingKey].on=!0,"#b-off":()=>H.buildings[H.selectedBuildingKey].on=!1,"#cd":()=>H.countdown-=1e4,"#kamikaze":()=>{H.karma<300||(H.karma-=300,H.countdown+=12e4,H.kamikazes+=1,2<=H.kamikazes?(H.peace=!0,t("Kamikaze!","Another divine wind washes away the Khan's fleet! Kublai Khan decides Japan is not worth conquering. You win!","üí®üå™Ô∏èüåä")):t("Kamikaze!","A divine wind washes away the Khan's fleet!","üí®üå™Ô∏èüåä"))}})}function be(e){const t=(e,t)=>{e=e.target.parentNode.querySelector('input[type="range"]'),t=Number(e.value||0)+t,e.setAttribute("value",t),e.value=t,t=new Event("change"),e.dispatchEvent(t)};me(e,{"#play":he,"#pause":fe,"#build":()=>H.creating=!0,"#upgra":()=>{H.upgradesOpen=!H.upgradesOpen,H.creating=!1,H.assigning=!1},"#cancel":()=>H.creating=!1,"#restart":()=>window.location.reload(),"#jobs":()=>{H.upgradesOpen=!1,H.creating=!1,H.assigning=!H.assigning,U()},".dec-range":e=>t(e,-1),".inc-range":e=>t(e,1)})}function we(i){var e=i["el"];let r;var o=i.x,a=i.y,t=()=>{r=null,H.moving=!1,g()};e.addEventListener("pointerup",t),e.addEventListener("pointercancel",t),e.addEventListener("pointerout",t),e.addEventListener("pointerleave",t),$(e,"pointermove",e=>{var t;r&&(t=e.clientY-r.clientY,i.x=o+(e.clientX-r.clientX),i.y=a+t,g())}),$(e,"pointerdown",e=>{var t=e.target,n=t.classList;H.state="game",n.contains("building")?(t=H.buildings[t.closest("g").id],H.creating&&H.selectedBuildingKey&&(c(t.key,H.selectedBuildingKey),H.creating=!1),H.selectedBuildingKey=t.key):H.creating&&H.selectedBuildingKey?(H.creating=!1,t=d({x:e.offsetX,y:e.offsetY,type:"connector"},H.selectedBuildingKey),H.selectedBuildingKey=t.key):(H.selectedBuildingKey=null,H.upgradesOpen=!1,H.assigning=!1),e.preventDefault(),g(),H.moving=!0,r=e,o=i.x,a=i.y}),$(document.querySelector("#flash"),"pointerdown",()=>{H.flashMessage=null,g()}),$(document.querySelector("#bui"),"pointerdown",be),$(document.querySelector("#tui"),"pointerdown",ve),X((r,o)=>{$(o,"change",()=>{var e=function(i,e){const r=W(),o={...r,[i]:e};if((e=o[i]-r[i])<=0)o.idle+=-1*e;else{let n=e;if("idle"!==i&&(e=Math.min(r.idle,e),n-=e,o.idle-=e),!(n<=0)){const a=L.reduce((e,t)=>(t!==i&&"idle"!==t&&e.push(t),e),[]);a.forEach((e,t)=>{t=Math.min(Math.ceil(n/(a.length-t||1)),r[e]),n-=t,o[e]-=t})}}return o}(r,Number(o.value)||0);{var[t={}]=[e];const n=I(),i=e=>(n[e]||0)<t[e];s(H.citizenKeys,H.meeples,e=>{e=(i(e.job)||(e.job=L.find(i)||"idle",e.path=[]),e.job),n[e]=(n[e]||0)+1}),L.forEach(()=>{})}U(),g()})})}const n=window.enableAsserts?(...e)=>console.assert(...e):()=>{};class E{constructor(e=0,t=0){this.x=e,this.y=t}copy(){return new E(this.x,this.y)}add(e){return n(null!=e.x),new E(this.x+e.x,this.y+e.y)}subtract(e){return n(null!=e.x),new E(this.x-e.x,this.y-e.y)}multiply(e){return n(null!=e.x),new E(this.x*e.x,this.y*e.y)}divide(e){return n(null!=e.x),new E(this.x/e.x,this.y/e.y)}scale(e){return n(null==e.x),new E(this.x*e,this.y*e)}length(){return this.lengthSquared()**.5}lengthSquared(){return this.x**2+this.y**2}distance(e){return this.distanceSquared(e)**.5}distanceSquared(e){return(this.x-e.x)**2+(this.y-e.y)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new E(0,e)}clampLength(e=1){var t=this.length();return e<t?this.scale(e/t):this}dot(e){return n(null!=e.x),this.x*e.x+this.y*e.y}cross(e){return n(null!=e.x),this.x*e.y-this.y*e.x}angle(){return Math.atan2(this.x,this.y)}setAngle(e=0,t=1){return this.x=t*Math.sin(e),this.y=t*Math.cos(e),this}rotate(e){var t=Math.cos(e);return e=Math.sin(e),new E(this.x*t-this.y*e,this.x*e+this.y*t)}direction(){return abs(this.x)>abs(this.y)?this.x<0?3:1:this.y<0?2:0}invert(){return new E(this.y,-this.x)}floor(){return new E(Math.floor(this.x),Math.floor(this.y))}area(){return abs(this.x*this.y)}lerp(e,t){return n(null!=e.x),this.add(e.subtract(this).scale(clamp(t)))}arrayCheck(e){return 0<=this.x&&0<=this.y&&this.x<e.x&&this.y<e.y}toString(e=3){return`(${(this.x<0?"":" ")+this.x.toFixed(e)},${(this.y<0?"":" ")+this.y.toFixed(e)} )`}}const j=2*Math.PI,$=(e,t,n)=>e.addEventListener(t,n),S=(e,t)=>(e=document.createElementNS("http://www.w3.org/2000/svg",e),t.appendChild(e),e),z=(t,n)=>{Object.keys(n).forEach(e=>{t.setAttribute(e,n[e])})},q=(e,t)=>{var n="object"==typeof e?e:document.querySelector(e);if(n)return n.innerHTML!==t&&(n.innerHTML=t,!0);throw Error("Cannot find element "+e)},B=e=>`translate(${e.x}px, ${e.y}px)`,O=(e=1,t=0)=>t+(e-t)*Math.random(),N=(e=1,t=0)=>0|O(e,t),C=(e=0,t)=>null==e.x?new E(e,null==t?e:t):new E(e.x,e.y),xe=Object.freeze({grain:{shape:"polygon",sides:3,r:6,offsetAngle:1/6*j},rice:{shape:"polygon",sides:5,r:6},wood:{shape:"polygon",sides:4,r:6,offsetAngle:.125*j},stone:{shape:"polygon",sides:4,r:6},ore:{shape:"polygon",sides:3,r:6}}),ke=[{key:"idle",name:"Wanderer",altName:"Idle",classification:"üí§"},{key:"prod",name:"Farmer/Artisan",altName:"Production",classification:"ü™ö"},{key:"carr",name:"Carrier/Merchant",altName:"Transportation",classification:"üß∫"},{key:"defe",name:"Samurai/Soldier",altName:"Defenders",classification:"üõ°Ô∏è"},{key:"spir",name:"Monk/Pilgrim",altName:"Spiritualist",classification:"ü™∑"}].reduce((e,t)=>(e[t.key]=t,e),{}),L=Object.keys(ke),Ke={name:"",r:10,cap:0,cost:[],upgrades:[],defMax:0,popMax:0,input:[],output:[],rate:0,autoWork:!1,classification:""},A=[{key:"outpost",name:"Outpost",r:24,cap:6,cost:["wood","wood","stone","stone"],defMax:2,popMax:2,classification:"üö©"},{key:"connector",name:"Crossroad",r:14,cap:2,cost:[],upgrades:"shrine tower stockpile stoneMine farmHouse woodCutter grainFarm".split(" "),classification:"ü™ß"},{key:"stockpile",name:"Stockpile",r:34,cap:20,cost:["stone","wood","grain"],upgrades:["warehouse"],classification:"üì¶"},{key:"warehouse",name:"Warehouse",r:46,cap:40,cost:["stone","stone"],classification:"üì¶"},{key:"woodCutter",name:"Woodcutter",r:24,cap:6,cost:["grain"],input:["grain"],output:["wood"],rate:4,classification:"ü™ö"},{key:"stoneMine",name:"Stone Mine",r:24,cap:6,cost:["wood","wood","wood","grain"],input:["grain"],output:["stone"],rate:1.5,upgrades:["oreMine"],classification:"ü™ö"},{key:"oreMine",name:"Ore Mine",r:34,cap:6,cost:["wood","stone","grain"],input:["wood","grain"],output:["ore"],rate:1,classification:"ü™ö"},{key:"tower",name:"Watchtower",r:18,cap:2,cost:["stone","wood","wood"],defMax:3,upgrades:["fortress"],classification:"üõ°Ô∏è"},{key:"fortress",name:"Fortress",r:28,cap:4,cost:["stone","stone","stone","wood","ore"],defMax:6,classification:"üõ°Ô∏è"},{key:"grainFarm",name:"Grain farm",r:24,cap:8,cost:["wood","wood"],input:[],output:["grain"],rate:3,upgrades:["riceFarm"],classification:"ü™ö"},{key:"riceFarm",name:"Rice farm",r:28,cap:6,cost:["wood","wood","ore","ore"],input:[],output:["rice"],rate:4,classification:"ü™ö"},{key:"shrine",name:"Shrine",r:20,cap:6,cost:["wood","stone","ore"],input:["rice"],output:["karma"],rate:3,upgrades:["temple"],classification:"ü™∑"},{key:"temple",name:"Temple",r:36,cap:6,cost:["stone","ore","ore","rice"],input:["rice"],output:["karma","karma"],rate:4,classification:"ü™∑"},{key:"farmHouse",name:"Noka (farmhouse)",r:20,cap:2,cost:["wood","wood","wood"],input:["grain"],output:["meeple"],rate:1,popMax:3,upgrades:["urbanHouse"],autoWork:!0,classification:"üõñ"},{key:"urbanHouse",name:"Machiya (urban house)",r:30,cap:4,cost:["wood","wood","ore","rice","rice"],input:["rice"],output:["meeple"],rate:1,popMax:8,autoWork:!0,classification:"üõñ"}].reduce((e,t)=>(e[t.key]={...Ke,...t},e),{}),H=window.g={state:"intro",world:{},buildings:{},buildingKeys:[],meeples:{},citizenKeys:[],invaderKeys:[],roads:{},roadKeys:[],flashMessage:null,selectedBuildingKey:null,upgradesOpen:!1,countdownEl:null,peace:!1,kamikazes:0,lastTime:0,karma:0,countdown:3e5,looping:!1,moving:!1,creating:!1,assigning:!1,godMode:!1,zoom:1,start:function(){var e=2*window.innerWidth,t=window.innerHeight,n=document.querySelector("#wc"),i=(z(n,{width:e,height:t}),document.querySelector("#w")),r=document.querySelector("#ws");z(r,{viewBox:`0 0 ${e} `+t}),H.world={c:n,el:i,svg:r,width:e,height:t,ctx:n.getContext("2d"),layers:{road:document.querySelector("#layer-road"),building:document.querySelector("#layer-building"),meeple:document.querySelector("#layer-meeple")},x:-.5*e,y:0},q("#jass",`<div>Loyal to H≈çj≈ç clan: <span id="mcounts"></span>
		<br><span class="altname">Build houses or towers to increase capacity.</span></div>
		<ul>${L.map(e=>{var t=ke[e];return`<li id="jr-${e}">
			<label for="input-${e}">
				<span>
					${t.name}
					<span class="altname">(${t.altName})</span>
				</span>
				<i>${t.classification}</i>
			</label><b><span class="jr-num"></span></b>
			<div class="jass-ui">
				<button class="dec-range">-</button>
				<input id="input-${e}" type="range" min="0">
				<button class="inc-range">+</button>
			</div>
		</li>`}).join("")}</ul>`),we(H.world),(i=d({type:"outpost",x:n=e/2-40,y:t/=2})).inv=["wood","wood"],d({type:"connector",x:n-(100+N(e/6)),y:t+N(200)-N(200)},i.key),p(),p(),p(),g()},destroyMeeple:ne};window.$=e=>document.querySelector(e),document.addEventListener("DOMContentLoaded",H.start)}();