!function(){function o(e="U"){return[e,D(9999).toString(36),Number(new Date).toString(36)].join("-")}function a(e,n,r){e.map((e,t)=>r(n[e],e,t))}function t(){return 1+C.s.reduce((e,t)=>e+(N[C.i[t].type].M||0),0)}function n(){return C.s.reduce((e,t)=>e+(N[C.i[t].type].K||0),0)}function s(e,t,n={}){var r=e<t;if(e={key:o("R"),from:r?e:t,da:r?t:e,...n},C.X[e.key])throw Error("Existing building");C.X[e.key]=e,C.ca.push(e.key)}function u(e,t=0){var n=N[e.type]["rate"];n?(t=Number.isNaN(t)?0:t,e.N=1/n*6e4+t,e.C=e.N):e.C=0}function l(e={},t=null){if(u(e={key:o("B"),type:"connector",R:!1,C:0,N:0,B:!0,h:[],refresh:!1,x:D(C.F.size),y:D(C.F.size),...e}),C.i[e.key])throw Error("Existing building");return console.log("Adding building",e),C.i[e.key]=e,C.s.push(e.key),t&&s(e.key,t),e}function c(e={}){if(!(C.A.length>=t())){if(e={key:o("M"),u:"idle",wa:100,fa:.5,ra:null,Da:null,pa:null,path:[],h:[],x:D(C.F.size),y:D(C.F.size),...e},C.H[e.key])throw Error("Existing meeple");return console.log("Adding meeple",e),C.H[e.key]=e,C.A.push(e.key),e}}function d(){return L.reduce((e,t)=>({...e,[t]:0}),{})}function h(){return C.A.reduce((e,t)=>(e[(t=C.H[t]).u]=(e[t.u]||0)+1,e),d())}function y(e){var t,n=N[e.type].r+4,r=0===e.N?0:1-e.C/e.N;e=document.getElementById(e.key),e=e.querySelector(".b-prod-circle"),r=r,t=2*(n=n)*Math.PI,r*=t,A(e,{r:n,"stroke-width":"10","stroke-dasharray":[r,t-r].join(" "),"stroke-dashoffset":40})}function p(e,n,r=10){const t=[...n.children],o=[...e];t.forEach(e=>{var t=e.dataset.za;!t||-1===(t=o.indexOf(t))?e.remove():o.splice(t,1)}),o.forEach(e=>{var t=q("circle",n);A(t,{r:4,I:"res res-"+e,"data-res":e}),e=F(0,0).na(B(2*Math.PI),B(r)),t.style.cx=e.x,t.style.cy=e.y})}function i(){const i=C.F.ga;a(C.s,C.i,e=>{var t,n,r=N[e.type],o=document.getElementById(e.key);o&&e.refresh&&(o.remove(),o=null,e.refresh=!1),o||(t=N[e.type],o=q("g",i.ea),A(o,{id:e.key,style:"transform: "+`translate(${e.x}px, ${e.y}px)`}),n=q("circle",o),A(n,{I:"b-prod-circle b-prod-"+e.type}),y(e),n=q("circle",o),A(n,{r:t.r,I:"building b-"+e.type}),t=q("g",o),A(t,{I:"b-res-g res-g"})),o.classList.toggle("selectedb",e.key===C.o),y(e),p(e.h,o.querySelector(".res-g"),r.r)})}function g(n){L.forEach(e=>{var t=document.querySelector("#jr-"+e);n(e,t.querySelector('input[type="range"]'),t,t.querySelector(".jr-num"))})}function H(){var o,i,a;C.J&&(o=h(),i=C.A.length,a=Math.min(i,n()),g((e,t,n,r)=>{n=o[e],r.innerText=n,t.max!==(e="defe"===e?a:i)&&(t.setAttribute("max",e),t.max=e),t.value!==n&&(t.setAttribute("value",n),t.value=n)}))}function I(){var e=`${C.A.length} / max: ${t()}, Defenders max: `+n();O("#mcounts",e)}function z(){(o=document.querySelector("main").classList).toggle("bselected",C.o),o.toggle("looping",C.W),o.toggle("creating",C.v),o.toggle("moving",C.aa),o.toggle("assigning",C.J),o.toggle("pop",0<C.A.length),C.Z||(C.Z=document.getElementById("cd"));var e,t,n,r=C.T,o=Math.floor(1/60*r*.001),r=Math.floor(.001*(r-6e4*o));O(C.Z,`${C.ba?"☮️":"⚔️"} ${o}:`+(r<10?"0":"")+r),O("#karma",C.G?`🪷 Karma: ${C.G} /300`:""),document.querySelector("#kamikaze").style.display=300<=C.G?"block":"none",C.o&&(o=C.i[C.o],(r=o)&&(n=N[r.type],e=`<button ${r.B?'disabled="disabled"':' id="b-on"'}><i>🕯️</i><b>On</b></button>
		<button ${r.B?'id="b-off"':'disabled="disabled"'}><i>🚫</i><b>Off</b></button>`,t=`<div>🪚 Production:
			<span class="prodin ${r.R?"supplied":"missing"}">
				${n.input.length?n.input.join(", "):"(No input)"}
			</span>
			➡️ ${n.m.length?n.m.join(", "):"(No output)"}
			<span>(${n.rate}/min)</span>
			<span id="b-progress">%</span>
		</div>`,n=`<div>
			<div class="b-name">${n.g} ${n.name||r.type}</div>
			<div>📦 Resources: ${r.h.join(", ")} (${r.h.length} / max: ${n.j})</div>
			${v(r)?t:""}
			${n.M?`<div>+${n.M} max citizens</div>`:""}
			${n.K?`<div>+${n.K} max defenders</div>`:""}
		</div>
		<div>
			${e}
		</div>`,O("#binfo",n),v(r))&&(n=Math.floor(100*(0===r.N?0:1-r.C/r.N)),O("#b-progress",w(r)?n+"%":"")),o=N[o.type]["D"],o=o.length?o.map(e=>{var{name:t=e,l:n,g:r}=N[e];return`<li class="up-action ${W(n)?"affordable":"unaffordable"}" data-upgrade="${e}" data-building="${C.o}">
					<span class="up-name">${r} ${t}</span>
					<span class="up-cost">${n}</span>
				</li>`}).join(""):"No upgrades",O("#blist",C.S?o:"")),I()}function m(){var r,e=C.F;e.L.style.top=e.y+"px",e.L.style.left=e.x+"px",e.L.style.width=C.F.size*C.zoom+"px",e.L.style.height=e.L.style.width,r=e.ga,i(),a(C.ca,C.X,e=>{var t,n;document.getElementById(e.key)||((t=q("line",r.ma)).id=e.key,n=C.i[e.from],e=C.i[e.da],A(t,{x1:n.x,y1:n.y,x2:e.x,y2:e.y,I:"road"}))}),a(C.A,C.H,e=>{var t,n=document.getElementById(e.key);n||(n=q("g",r.la),A(n,{id:e.key,style:"transform: "+`translate(${e.x}px, ${e.y}px)`,I:"meeple-g"}),t=q("circle",n),A(t,{r:7,I:"meeple mj-"+e.u}),t=q("g",n),A(t,{I:"m-res-g res-g"})),n.querySelector(".meeple").setAttribute("class","meeple mj-"+e.u),n.style.transform=`translate(${e.x}px, ${e.y}px)`,p(e.h,n.querySelector(".res-g"),7)}),z()}function T(e=[]){const t=function(){const t={};return a(C.s,C.i,e=>{e.h.forEach(e=>{t[e]=(t[e]||0)+1})}),t}(),n=e.reduce((e,t)=>({...e,[t]:(e[t]||0)+1}),{}),r={};return Object.keys(n).forEach(e=>{r[e]=n[e]-(t[e]||0),r[e]<0&&(r[e]=0)}),r}function W(e=[]){const n=T(e);return Object.keys(n).reduce((e,t)=>e+n[t],0)<=0}function f(t){return C.s.filter(e=>(e=C.i[e],t(e,N[e.type])))}function K(n){let r=1/0,o=null;return a(C.s,C.i,e=>{var t=F(e).U(n);t>=r||(r=t,o=e)}),o}function P(e,t){var n=N[t.type];return F(t).U(e)<=n.r}function R(e){var t,n=K(e);return!n||(t=N[n.type],F(n).U(e)>t.r)?null:n}function G(e=[],n){const r="string"==typeof e?[e]:[...e];if(20<=r.length||r.includes(n))return r;var o;if(o=r[r.length-1],(e=C.ca.reduce((e,t)=>((t=C.X[t]).from===o?e.push(t.da):t.da===o&&e.push(t.from),e),[])).includes(n))return r.concat(n);let i=1/0,a=null;return e=e.map(e=>{let t=[...r];return r.includes(e)||(t.push(e),(t=G(t,n)).includes(n)&&t.length<=i&&(a=t,i=t.length)),t}),null===a?e[0]:a}function v(e){return(e=N[e.type]).input&&e.input.length||e.m&&e.m.length}function w(e){return v(e)&&e.B}function x(e,t){var n=R(e);return n&&(!t||t.key===n.key)&&(t=w(n),n=N[n.type],t)&&("prod"===e.u&&"🪚"===n.g||"spir"===e.u&&"🪷"===n.g)}function X(e){if(!e.B)return[...e.h];const r=[...N[e.type].input];return e.h.reduce((e,t)=>{var n=r.indexOf(t);return 0<n?r.splice(n,1):e.push(t),e},[])}function k(e){return e.h.length>=N[e.type].j}function b(e,t=[],n=!1){{if(t.length){if(n&&([n,a=[]]=[e,t],0!==n.h.reduce((e,t)=>(0<=(t=e.indexOf(t))&&e.splice(t,1),e),[...a]).length))return[...t];var[r,o=[]]=[e.h,t];if(!o.length)return[];o=[...o];for(let e=r.length;e--;e){var i=o.indexOf(r[e]);0<=i&&(o.splice(i,1),r.splice(e,1))}return o}return[]}var a}function $(e){return!!(e.path.length&&(n=(t=e).path[0],r=2,F(t).U(n)<=r))&&(e.path.shift(),!0);var t,n,r}function j(e,t){void 0!==(t=(t=(t="string"==typeof t?[t]:t).length?t:C.s)[D(t.length)])&&(e.path=(t=C.i[t],(e=K(e=e))?G([e.key],t.key).map(e=>{var t=C.i[e];return{key:e,x:t.x,y:t.y}}):[]))}function M(e,t,n,r){r*=n,n=F(e),t=F(t).oa(n).ha(r),t=n.add(t),e.x=t.x,e.y=t.y}function Y(e,t){e.x+=(t*=.0225)*(2*(0|B(2))-1),e.y+=t*(2*(0|B(2))-1)}function J(e,t){$(e),e.path.length?M(e,e.path[0],t,.03):j(e,C.s)}function U(e,t){$(e),e.path.length?M(e,e.path[0],t,.12):(x(e)?Y:(t=f((e,t)=>w(e)&&"🪚"===t.g),j))(e,t)}function V(i,e){var t,n,r,o=$(i);if(i.path.length)M(i,i.path[0],e,.132*(i.h.length?.6:1));else{if(e=[],e=R(i),i.h.length){if(o&&e)return r=e,void((n=i).h.length&&P(n,r)&&(n=n.h.shift(),r.h.push(n)));0===(e=f(e=>{return t=e,n=i.h[0],!!t.B&&(r=(e,t)=>e+(t===n?1:0),o=N[t.type].input.reduce(r,0),(t=t.h.reduce(r,0))<o)&&!k(e);var t,n,r,o})).length&&(e=f((e,t)=>"📦"===t.g&&!k(e)&&e.B))}else{if(o&&e)return r=e,void(0<(n=i).h.length||!P(n,r)||!(o=X(r)).length||0<b(r,[t=t&&o.includes(t)?t:o[D(o.length)]],!0).length||n.h.push(t));e=f(e=>(e=X(e))&&e.length)}j(i,e)}}function Z(e,t){$(e),e.path.length?M(e,e.path[0],t,.12):(e.fa=Math.min(e.fa+.05,.9),j(e,t=f((e,t)=>"🛡️"===t.g)))}function Q(e,t){$(e),e.path.length?M(e,e.path[0],t,.12):(x(e)?Y:(t=f((e,t)=>w(e)&&"🪷"===t.g),j))(e,t)}function _(i){C.A.forEach(e=>{var t={P:J,ya:U,qa:V,ta:Z,Ba:Q};t[(e=C.H[e]).u]&&t[e.u](e,i)}),C.s.forEach(e=>{e=C.i[e];var t,n,r,o=N[e.type];(o.m||o.input)&&e.B&&(o.input.length||(e.R=!0),e.R?(t=Math.min((r=e,C.A.reduce((e,t)=>e+(x(C.H[t],r)?1:0),0)),6),n=o.Y?1:0,e.C-=i*(t?t/t**.55:n),0<e.C||(e.C=0,[t,n=[]]=[e,o.m],(n.includes("meeple")?c({x:t.x,y:t.y}):n.includes("karma")?(n.forEach(e=>{"karma"===e&&(C.G+=1)}),1):!k(t)&&(t.h=t.h.concat([...n]),1))&&(e.R=!1,u(e,e.C)))):0<b(e,o.input,!0).length||(e.R=!0))}),C.ja.forEach(()=>{})}function ee(){var e,t;C.W&&(e=Number(new Date),t=C.V?e-C.V:0,C.V=e,C.ba||(C.T-=t),_(t),m(),setTimeout(ee,100))}function te(){C.W=!0,C.V=0,ee()}function ne(){C.W=!1}function re(n,r={}){const o=n.target;Object.keys(r).forEach(e=>{var t=o.closest(e);t&&r[e](n,t)}),z()}function oe(e){re(e,{".up-action":(e,t)=>{e=t.dataset.upgrade,t=C.i[t.dataset.ea];var{D:n=[]}=N[t.type];if(!n.includes(e))throw Error("Unknown upTypeKey");!function(e,n=[]){if(W(n)){let t=[...n];return t=b(e,t),a(C.s,C.i,e=>{t=b(e,t)}),1}}(t,N[e].l)||(t.type=e,t.refresh=!0,u(t),i()),C.v=!1},"#b-on":()=>C.i[C.o].B=!0,"#b-off":()=>C.i[C.o].B=!1,"#kamikaze":()=>{ne(),C.G<300||(C.G-=300,C.T=3e5,C.$+=1,window.alert("A divine wind washes away the invading fleet!"),2<=C.$&&(C.ba=!0,window.alert("You win")))}})}function ie(e){re(e,{"#play":te,"#pause":ne,"#build":()=>C.v=!0,"#upgra":()=>{C.S=!C.S,C.v=!1,C.J=!1},"#cancel":()=>C.v=!1,"#restart":()=>window.location.reload(),"#jobs":()=>{C.S=!1,C.v=!1,C.J=!C.J,H()}})}function ae(n){var e=n.L;let r;var o=n.x,i=n.y;E(e,"pointerup",()=>{r=null,C.aa=!1,m()}),E(e,"pointermove",e=>{var t;r&&(t=e.clientY-r.clientY,n.x=o+(e.clientX-r.clientX),n.y=i+t,m())}),E(e,"pointerdown",e=>{var t=e.target;t.classList.contains("building")?(t=C.i[t.closest("g").id],C.v&&C.o&&(s(t.key,C.o),C.v=!1),C.o=t.key):C.v&&C.o?(C.v=!1,t=l({x:e.offsetX,y:e.offsetY,type:"connector"},C.o),C.o=t.key):(C.o=null,C.S=!1,C.J=!1),e.preventDefault(),m(),C.aa=!0,r=e,o=n.x,i=n.y}),document.querySelector("#bui").addEventListener("pointerdown",ie),document.querySelector("#tui").addEventListener("pointerdown",oe),g((o,i)=>{E(i,"change",()=>{var e=function(r,e){const o=h(),i={...o,[r]:e};if((e=i[r]-o[r])<=0)i.P+=-1*e;else{let n=e;if("idle"!==r&&(e=Math.min(o.P,e),n-=e,i.P-=e),!(n<=0)){const a=L.reduce((e,t)=>(t!==r&&"idle"!==t&&e.push(t),e),[]);a.forEach((e,t)=>{t=Math.min(Math.ceil(n/(a.length-t||1)),o[e]),n-=t,i[e]-=t})}}return i}(o,Number(i.value)||0);console.log("Desiring",e);{var[t={}]=[e];const n=d(),r=e=>(n[e]||0)<t[e];a(C.A,C.H,e=>{r(e.u)||(e.u=L.find(r)||"idle",e.path=[]),e=e.u,n[e]=(n[e]||0)+1}),L.forEach(()=>{}),console.log("Meeples assigned jobs:",C.H,"desired:",t,"final:",n)}H(),m()})})}const r=window.ua?(...e)=>console.assert(...e):()=>{};class S{constructor(e=0,t=0){this.x=e,this.y=t}add(e){return r(null!=e.x),new S(this.x+e.x,this.y+e.y)}oa(e){return r(null!=e.x),new S(this.x-e.x,this.y-e.y)}multiply(e){return r(null!=e.x),new S(this.x*e.x,this.y*e.y)}scale(e){return r(null==e.x),new S(this.x*e,this.y*e)}length(){return this.ka()**.5}ka(){return this.x**2+this.y**2}U(e){return this.ia(e)**.5}ia(e){return(this.x-e.x)**2+(this.y-e.y)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new S(0,e)}ha(e=1){var t=this.length();return e<t?this.scale(e/t):this}angle(){return Math.atan2(this.x,this.y)}na(e=0,t=1){return this.x=t*Math.sin(e),this.y=t*Math.cos(e),this}rotate(e){var t=Math.cos(e);return e=Math.sin(e),new S(this.x*t-this.y*e,this.x*e+this.y*t)}direction(){return abs(this.x)>abs(this.y)?this.x<0?3:1:this.y<0?2:0}floor(){return new S(Math.floor(this.x),Math.floor(this.y))}toString(e=3){return`(${(this.x<0?"":" ")+this.x.toFixed(e)},${(this.y<0?"":" ")+this.y.toFixed(e)} )`}}const E=(e,t,n)=>e.addEventListener(t,n),q=(e,t)=>(e=document.createElementNS("http://www.w3.org/2000/svg",e),t.appendChild(e),e),A=(t,n)=>Object.keys(n).forEach(e=>t.setAttribute(e,n[e])),O=(e,t)=>(e="object"==typeof e?e:document.querySelector(e)).innerHTML!==t&&(e.innerHTML=t,!0),B=(e=1,t=0)=>t+(e-t)*Math.random(),D=(e=1,t=0)=>0|B(e,t),F=(e=0,t)=>null==e.x?new S(e,null==t?e:t):new S(e.x,e.y),se=[{key:"idle",name:"Wanderer",O:"Idle",g:"💤"},{key:"prod",name:"Farmer/Artisan",O:"Production",g:"🪚"},{key:"carr",name:"Carrier/Merchant",O:"Transportation",g:"🧺"},{key:"defe",name:"Samurai/Soldier",O:"Defenders",g:"🛡️"},{key:"spir",name:"Monk/Pilgrim",O:"Spiritualist",g:"🪷"}].reduce((e,t)=>(e[t.key]=t,e),{}),L=Object.keys(se),ue={name:"",r:10,j:0,l:[],D:[],K:0,M:0,input:[],m:[],rate:0,Y:!1,g:""},N=[{key:"outpost",name:"Outpost",r:20,j:6,l:["wood","wood","stone","stone"],K:1,M:2,g:"🚩"},{key:"connector",name:"Crossroad",r:10,j:3,l:[],D:"stoneMine grainFarm tower shrine farmHouse woodCutter stockpile".split(" "),g:"🪧"},{key:"stockpile",name:"Stockpile",r:30,j:20,l:["stone","wood","grain"],D:["warehouse"],g:"📦"},{key:"warehouse",name:"Warehouse",r:42,j:40,l:["stone","stone"],g:"📦"},{key:"woodCutter",name:"Woodcutter",r:20,j:6,l:["grain"],input:["grain"],m:["wood"],rate:4,g:"🪚"},{key:"stoneMine",name:"Stone Mine",r:20,j:6,l:["wood","wood","wood","grain"],input:["grain"],m:["stone"],rate:1.5,D:["oreMine"],g:"🪚"},{key:"oreMine",name:"Ore Mine",r:30,j:6,l:["wood","stone","grain"],input:["wood","grain"],m:["ore"],rate:1,g:"🪚"},{key:"tower",name:"Watchtower",r:14,j:2,l:["stone","wood","wood"],K:5,D:["fortress"],g:"🛡️"},{key:"fortress",name:"Fortress",r:24,j:4,l:["stone","stone","stone","wood","ore"],K:8,g:"🛡️"},{key:"grainFarm",name:"Grain farm",r:20,j:10,l:["wood","wood"],input:[],m:["grain"],rate:3,D:["riceFarm"],g:"🪚"},{key:"riceFarm",name:"Rice farm",r:24,j:6,l:["wood","wood","ore","ore"],input:[],m:["rice"],rate:4,g:"🪚"},{key:"shrine",name:"Shrine",r:16,j:6,l:["wood","stone","ore"],input:["rice"],m:["karma"],rate:3,D:["temple"],g:"🪷"},{key:"temple",name:"Temple",r:32,j:6,l:["stone","ore","ore","rice"],input:["rice"],m:["karma","karma"],rate:4,g:"🪷"},{key:"farmHouse",name:"Noka (farmhouse)",r:20,j:2,l:["wood","wood","wood"],input:["grain"],m:["meeple"],rate:1,M:3,D:["urbanHouse"],Y:!0,g:"🛖"},{key:"urbanHouse",name:"Machiya (urban house)",r:30,j:4,l:["wood","wood","ore","rice","rice"],input:["rice"],m:["meeple"],rate:1,M:8,Y:!0,g:"🛖"}].reduce((e,t)=>(e[t.key]={...ue,...t},e),{}),C=window.va={state:"game",F:{},i:{},s:[],H:{},A:[],X:{},ca:[],xa:{},ja:[],o:null,S:!1,Z:null,ba:!1,$:0,V:0,G:0,T:6e5,W:!1,aa:!1,v:!1,J:!1,zoom:1,start:function(){console.log("hello shikken");var e=Math.max(window.innerHeight,window.innerWidth),t=document.querySelector("#wc"),n=(A(t,{width:e,height:e}),document.querySelector("#w")),r=document.querySelector("#ws");A(r,{viewBox:`0 0 ${e} `+e}),C.F={c:t,L:n,Ca:r,size:e,sa:t.getContext("2d"),ga:{ma:document.querySelector("#layer-road"),ea:document.querySelector("#layer-building"),Aa:document.querySelector("#layer-resource"),la:document.querySelector("#layer-meeple")},x:window.innerWidth-e,y:0},O("#jass",`<div>Loyal to your Hōjō clan: <span id="mcounts"></span>
		<br><span class="altname">Build houses or towers to increase capacity.</span></div>
		<ul>${L.map(e=>{var t=se[e];return`<li id=jr-${e}><label for="input-${e}">${t.name} <span class="altname">(${t.O})</span> ${t.g}</label><b><span class=jr-num></span></b>
		<input id="input-${e}" type=range min=0></li>`}).join("")}</ul>`),I(),ae(C.F),(r=l({type:"outpost",x:t=e-40,y:n=e/2})).h=["wood","wood"],l({type:"connector",x:t-(100+D(e/3)),y:n+D(200)-D(200)},r.key),c(),c(),c(),m()}};document.addEventListener("DOMContentLoaded",C.start)}();