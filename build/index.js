!function(){function o(e="U"){return[e,C(9999).toString(36),Number(new Date).toString(36)].join("-")}function l(e,n,r){e.map((e,t)=>r(n[e],e,t))}function u(e,t,n={}){var r=e<t;if(e={key:o("R"),from:r?e:t,$:r?t:e,...n},O.U[e.key])throw Error("Existing building");O.U[e.key]=e,O.Z.push(e.key)}function a(e,t=0){var n=N[e.type]["rate"];n?(t=Number.isNaN(t)?0:t,e.I=1/n*6e4+t,e.A=e.I):e.A=0}function c(e={},t=null){if(a(e={key:o("B"),type:"connector",A:0,I:0,M:!0,resources:["wood","stone","wood","grain"],refresh:!1,x:C(O.B.size),y:C(O.B.size),...e}),O.h[e.key])throw Error("Existing building");return console.log("Adding building",e),O.h[e.key]=e,O.u.push(e.key),t&&u(e.key,t),e}function i(e={}){if(O.v.length>=1+O.u.reduce((e,t)=>e+(N[O.h[t].type].T||0),0))return console.warn("Could not add another meeple"),0;if(e={key:o("M"),o:"idle",sa:100,ka:null,Ca:null,ia:null,path:[],G:[],x:C(O.B.size),y:C(O.B.size),...e},O.D[e.key])throw Error("Existing meeple");return console.log("Adding meeple",e),O.D[e.key]=e,O.v.push(e.key),e}function d(){return I.reduce((e,t)=>({...e,[t]:0}),{})}function h(){return O.v.reduce((e,t)=>(e[(t=O.D[t]).o]=(e[t.o]||0)+1,e),d())}function s(e){var t,n=N[e.type].r+4,r=0===e.I?0:1-e.A/e.I;e=document.getElementById(e.key),e=e.querySelector(".b-prod-circle"),r=r,t=2*(n=n)*Math.PI,r*=t,q(e,{r:n,"stroke-width":"10","stroke-dasharray":[r,t-r].join(" "),"stroke-dashoffset":40})}function p(){const o=O.B.ba;l(O.u,O.h,e=>{var t,n,r=document.getElementById(e.key);r&&e.refresh&&(r.remove(),r=null,e.refresh=!1),r||(t=N[e.type],r=B("g",o.aa),q(r,{id:e.key,style:"transform: "+`translate(${e.x}px, ${e.y}px)`}),n=B("circle",r),q(n,{F:"b-prod-circle b-prod-"+e.type}),s(e),n=B("circle",r),q(n,{r:t.r,F:"building b-"+e.type}),t=B("g",r),q(t,{F:"b-res-g res-g"})),r.classList.toggle("selectedb",e.key===O.m),s(e),y(e.resources,r.querySelector(".res-g"))})}function y(e,n){var t=[...n.children];e=[...e],t.forEach(e=>{e.dataset.ya||e.remove()}),e.forEach(e=>{var t=B("circle",n);q(t,{r:4,F:"res res-"+e,"data-res":e}),t.style.cx=C(6)*(2*(0|Y(2))-1),t.style.cy=C(6)*(2*(0|Y(2))-1)})}function t(n){I.forEach(e=>{var t=document.querySelector("#jr-"+e);n(e,t.querySelector('input[type="range"]'),t,t.querySelector(".jr-num"))})}function g(){var o,i,a;O.K&&(o=h(),i=O.v.length,a=Math.min(i,O.u.reduce((e,t)=>e+(N[O.h[t].type].N||0),0)),t((e,t,n,r)=>{n=o[e],r.innerText=n,t.max!==(e="defe"===e?a:i)&&(t.setAttribute("max",e),t.max=e),t.value!==n&&(t.setAttribute("value",n),t.value=n)}))}function r(e){var t,n,r,o;return e?(n=`<button id="b-up-toggle"><i>👁️🛠️</i><b>Toggle Upgrades (${(t=N[e.type]).s.length})</b></button>`,r=`<button ${e.M?'disabled="disabled"':' id="b-on"'}><i>🕯️</i><b>On</b></button>
		<button ${e.M?'id="b-off"':'disabled="disabled"'}><i>🚫</i><b>Off</b></button>`,o=`<div>🪚 Production:
			${t.input.length?t.input.join(", "):"(No input)"}
			➡️ ${t.l.length?t.l.join(", "):"(No output)"}
			<span>(${t.rate}/min)</span>
			<span id="b-progress">%</span>
		</div>`,`<div>
			<div class="b-name">${t.g} ${t.name||e.type}</div>
			<div>📦 Resources: ${e.resources.join(", ")}</div>
			${k(e)?o:""}
		</div>
		<div>
			${r}
			${t.s.length?n:""}
		</div>`):""}function m(){(n=document.querySelector("main").classList).toggle("bselected",O.m),n.toggle("looping",O.S),n.toggle("creating",O.C),n.toggle("assigning",O.K),n.toggle("pop",0<O.v.length),O.Y||(O.Y=document.getElementById("cd"));var e,t=O.X,n=Math.floor(1/60*t*.001),t=Math.floor(.001*(t-6e4*n));A(O.Y,`⚔️ ${n}:`+(t<10?"0":"")+t),A("#karma",`🪷 Karma: ${O.P} /3000`),document.querySelector("#kamikaze").style.display=3e3<=O.P?"block":"none",O.m&&(n=O.h[O.m],(t=n)&&(e=r(t),A("#binfo",e),k(t))&&(e=Math.floor(100*(0===t.I?0:1-t.A/t.I)),A("#b-progress",x(t)?e+"%":"")),n=N[n.type]["s"],n=n?n.map(e=>{var{name:t=e,j:n,g:r}=N[e];return`<li class="up-action" data-upgrade="${e}" data-building="${O.m}">
					<span class="up-name">${r} ${t}</span>
					<span class="up-cost">${n}</span>
				</li>`}).join(""):"No upgrades",A("#blist",O.V?n:""))}function f(){var r,e=O.B;e.H.style.top=e.y+"px",e.H.style.left=e.x+"px",e.H.style.width=O.B.size*O.zoom+"px",e.H.style.height=e.H.style.width,r=e.ba,p(),l(O.Z,O.U,e=>{var t,n;document.getElementById(e.key)||((t=B("line",r.ga)).id=e.key,n=O.h[e.from],e=O.h[e.$],q(t,{x1:n.x,y1:n.y,x2:e.x,y2:e.y,F:"road"}))}),l(O.v,O.D,e=>{var t,n=document.getElementById(e.key);n||(n=B("g",r.fa),q(n,{id:e.key,style:"transform: "+`translate(${e.x}px, ${e.y}px)`,F:"meeple-g"}),t=B("circle",n),q(t,{r:7,F:"meeple mj-"+e.o}),t=B("g",n),q(t,{F:"m-res-g res-g"})),n.querySelector(".meeple").setAttribute("class","meeple mj-"+e.o),n.style.transform=`translate(${e.x}px, ${e.y}px)`,y(e.G,n.querySelector(".res-g"))}),m()}function v(t){return O.u.filter(e=>(e=O.h[e],t(e,N[e.type])))}function X(n){let r=1/0,o=null;return l(O.u,O.h,e=>{var t=F(e).O(n);t>=r||(r=t,o=e)}),o}function D(e,t){var n=N[t.type];return F(t).O(e)<=n.r}function H(e){var t,n=X(e);return!n||(t=N[n.type],F(n).O(e)>t.r)?null:n}function z(e=[],n){const r="string"==typeof e?[e]:[...e];if(20<=r.length||r.includes(n))return r;var o;if(o=r[r.length-1],(e=O.Z.reduce((e,t)=>((t=O.U[t]).from===o?e.push(t.$):t.$===o&&e.push(t.from),e),[])).includes(n))return r.concat(n);let i=1/0,a=null;return e=e.map(e=>{let t=[...r];return r.includes(e)||(t.push(e),(t=z(t,n)).includes(n)&&t.length<=i&&(a=t,i=t.length)),t}),null===a?e[0]:a}function k(e){return(e=N[e.type]).input&&e.input.length||e.l&&e.l.length}function x(e){return k(e)&&e.M}function b(e,t){var n=H(e);return n&&(!t||t.key===n.key)&&(t=x(n),n=N[n.type],t)&&("prod"===e.o&&"🪚"===n.g||"spir"===e.o&&"🪷"===n.g)}function w(e){const r=[...N[e.type].input];return e.resources.reduce((e,t)=>{var n=r.indexOf(t);return 0<n?r.splice(n,1):e.push(t),e},[])}function T(e){return(e=w(e))&&e.length}function L(e,n){var t=(e,t)=>e+(t===n?1:0),r=N[e.type].input.reduce(t,0);return(e=e.resources.reduce(t,0))<r}function G(t,n=[]){if(!n.length)return 1;if([e,r=[]]=[t,n],0===e.resources.reduce((e,t)=>(0<=(t=e.indexOf(t))&&e.splice(t,1),e),[...r]).length){var e,r;n=[...n];for(let e=t.resources.length;e--;e){var o=n.indexOf(t.resources[e]);0<=o&&(n.splice(o,1),t.resources.splice(e,1))}return 0===n.length}}function P(e,t=[]){return t.includes("meeple")?i({x:e.x,y:e.y}):t.includes("karma")?void t.forEach(e=>{"karma"===e&&(O.P+=1)}):!(e.resources.length>=N[e.type].i)&&(e.resources=e.resources.concat([...t]),1)}function K(e,t){return!(!e.G.length||!D(e,t)||(e=e.G.shift(),t.resources.push(e),0))}function R(e,t,n){var r;return!(0<e.G.length||!D(e,t)||!(r=w(t)).length||!G(t,[n=n&&r.includes(n)?n:r[C(r.length)]])||(e.G.push(n),0))}function $(e){return!!(e.path.length&&(n=(t=e).path[0],r=2,F(t).O(n)<=r))&&(e.path.shift(),!0);var t,n,r}function M(e,t){t=(t=(t="string"==typeof t?[t]:t).length?t:O.u)[C(t.length)],console.log("Pick random building",t),void 0!==t&&(e.path=(t=O.h[t],(e=X(e=e))?z([e.key],t.key).map(e=>{var t=O.h[e];return{key:e,x:t.x,y:t.y}}):[]))}function j(e,t,n,r){r*=n,n=F(e),t=F(t).ha(n).ca(r),t=n.add(t),e.x=t.x,e.y=t.y}function U(e,t){e.x+=(t=t*(.14*.75)*.25)*(2*(0|Y(2))-1),e.y+=t*(2*(0|Y(2))-1)}function W(e,t){$(e),e.path.length?j(e,e.path[0],t,.07):M(e,O.u)}function J(e,t){$(e),e.path.length?j(e,e.path[0],t,.07):(b(e)?U:(t=v((e,t)=>x(e)&&"🪚"===t.g),M))(e,t)}function V(t,e){var n=$(t);if(t.path.length)j(t,t.path[0],e,.07);else{if(e=[],e=H(t),t.G.length){if(n&&e)return console.log("Attempt drop"),void K(t,e);0===(e=v(e=>L(e,t.G[0]))).length&&(e=v((e,t)=>"📦"===t.g))}else{if(n&&e)return console.log("Attempt pickup"),void R(t,e);e=v(e=>T(e))}M(t,e)}}function Z(e,t){$(e),e.path.length?j(e,e.path[0],t,.07):M(e,t=v((e,t)=>"🛡️"===t.g))}function Q(e,t){$(e),e.path.length?j(e,e.path[0],t,.07):(b(e)?U:(t=v((e,t)=>x(e)&&"🪷"===t.g),M))(e,t)}function _(i){O.v.forEach(e=>{var t={L:W,xa:J,ja:V,ma:Z,Aa:Q};t[(e=O.D[e]).o]&&t[e.o](e,i)}),O.u.forEach(e=>{e=O.h[e];var t,n,r,o=N[e.type];(o.l||o.input)&&(t=Math.min((r=e,O.v.reduce((e,t)=>e+(b(O.D[t],r)?1:0),0)),6),n=o.W?1:0,e.A-=i*(t?t/t**.55:n),0<e.A||(e.A=0,G(e,o.input)&&(P(e,o.l)?a(e,e.A):P(e,o.input))))})}function ee(){var e,t;O.S&&(e=Number(new Date),t=O.R?e-O.R:0,O.R=e,O.X-=t,_(t),f(),setTimeout(ee,100))}function te(){O.S=!0,O.R=0,ee()}function ne(){O.S=!1}function re(e){return O.m=e.key,r(e)}function oe(n,r={}){const o=n.target;Object.keys(r).forEach(e=>{var t=o.closest(e);t&&r[e](n,t)}),m()}function ie(e){oe(e,{".up-action":(e,t)=>{e=t.dataset.upgrade,t=O.h[t.dataset.aa];var{s:n=[]}=N[t.type];if(!n.includes(e))throw Error("Unknown upTypeKey");t.type=e,t.refresh=!0,a(t),p(),O.C=!1},"#b-on":()=>O.h[O.m].M=!0,"#b-off":()=>O.h[O.m].M=!1,"#b-up-toggle":()=>O.V=!O.V})}function ae(e){oe(e,{"#play":te,"#pause":ne,"#build":()=>O.C=!0,"#cancel":()=>O.C=!1,"#restart":()=>window.location.reload(),"#jobs":()=>{O.K=!O.K,g()}})}function se(o){var e=o.H;let i=null;var a=o.x,s=o.y;E(e,"pointerup",()=>{i=null}),E(e,"pointermove",e=>{var t;i&&(t=e.clientY-i.clientY,o.x=a+(e.clientX-i.clientX),o.y=s+t,f())}),E(e,"pointerdown",e=>{var t=e.target,n=t.classList;let r="";n.contains("building")?(t=O.h[t.closest("g").id],O.C&&O.m&&(u(t.key,O.m),O.C=!1),r=re(t)):O.C&&O.m?(O.C=!1,console.log({clientX:e.clientX,clientY:e.clientY,layerX:e.layerX,layerY:e.layerY,offsetX:e.offsetX,offsetY:e.offsetY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY}),t=c({x:e.offsetX,y:e.offsetY,type:"connector"},O.m),r=re(t)):(O.m=null,O.V=!1,O.K=!1,n.contains("road")&&(r="road")),A("#binfo",r),f(),i=e,a=o.x,s=o.y}),E(document.querySelector("body"),"wheel",e=>{O.zoom=Math.min(Math.max(O.zoom+-.001*e.deltaY,.1),3),f(),console.log(e.deltaY)}),E(document.getElementById("bui"),"pointerdown",ae),E(document.getElementById("tui"),"pointerdown",ie),t((o,i)=>{E(i,"change",()=>{var e=function(r,e){const o=h(),i={...o,[r]:e};if((e=i[r]-o[r])<=0)i.L+=-1*e;else{let n=e;if("idle"!==r&&(e=Math.min(o.L,e),n-=e,i.L-=e),!(n<=0)){const a=I.reduce((e,t)=>(t!==r&&"idle"!==t&&e.push(t),e),[]);a.forEach((e,t)=>{t=Math.min(Math.ceil(n/(a.length-t||1)),o[e]),n-=t,i[e]-=t})}}return i}(o,Number(i.value)||0);console.log("Desiring",e);{var[t={}]=[e];const n=d(),r=e=>(n[e]||0)<t[e];l(O.v,O.D,e=>{r(e.o)||(e.o=I.find(r)||"idle",e.path=[]),e=e.o,n[e]=(n[e]||0)+1}),I.forEach(()=>{}),console.log("Meeples assigned jobs:",O.D,"desired:",t,"final:",n)}g(),f()})})}const n=window.oa?(...e)=>console.assert(...e):()=>{};class S{constructor(e=0,t=0){this.x=e,this.y=t}add(e){return n(null!=e.x),new S(this.x+e.x,this.y+e.y)}ha(e){return n(null!=e.x),new S(this.x-e.x,this.y-e.y)}multiply(e){return n(null!=e.x),new S(this.x*e.x,this.y*e.y)}scale(e){return n(null==e.x),new S(this.x*e,this.y*e)}length(){return this.ea()**.5}ea(){return this.x**2+this.y**2}O(e){return this.da(e)**.5}da(e){return(this.x-e.x)**2+(this.y-e.y)**2}normalize(e=1){var t=this.length();return t?this.scale(e/t):new S(0,e)}ca(e=1){var t=this.length();return e<t?this.scale(e/t):this}angle(){return Math.atan2(this.x,this.y)}rotate(e){var t=Math.cos(e);return e=Math.sin(e),new S(this.x*t-this.y*e,this.x*e+this.y*t)}direction(){return abs(this.x)>abs(this.y)?this.x<0?3:1:this.y<0?2:0}floor(){return new S(Math.floor(this.x),Math.floor(this.y))}toString(e=3){return`(${(this.x<0?"":" ")+this.x.toFixed(e)},${(this.y<0?"":" ")+this.y.toFixed(e)} )`}}const E=(e,t,n)=>e.addEventListener(t,n),B=(e,t)=>(e=document.createElementNS("http://www.w3.org/2000/svg",e),t.appendChild(e),e),q=(t,n)=>Object.keys(n).forEach(e=>t.setAttribute(e,n[e])),A=(e,t)=>(e="object"==typeof e?e:document.querySelector(e)).innerHTML!==t&&(e.innerHTML=t,!0),Y=(e=1,t=0)=>t+(e-t)*Math.random(),C=(e=1,t=0)=>0|Y(e,t),F=(e=0,t)=>null==e.x?new S(e,null==t?e:t):new S(e.x,e.y),le=[{key:"idle",name:"Wanderer",J:"Idle",g:"💤"},{key:"prod",name:"Farmer/Artisan",J:"Production",g:"🪚"},{key:"carr",name:"Carrier/Merchant",J:"Transportation",g:"🧺"},{key:"defe",name:"Samurai/Soldier",J:"Defenders",g:"🛡️"},{key:"spir",name:"Monk/Pilgrim",J:"Spiritualist",g:"🪷"}].reduce((e,t)=>(e[t.key]=t,e),{}),I=Object.keys(le),ue={name:"",r:10,i:0,j:[],s:[],N:0,T:0,input:[],l:[],rate:0,W:!1,g:""},N=[{key:"outpost",name:"Outpost",r:20,i:19,j:["wood","wood","stone","stone"],N:2,T:10,g:"🚩"},{key:"connector",name:"Crossroad",r:10,i:4,j:[],s:"stoneMine grainFarm tower shrine farmHouse woodCutter stockpile".split(" "),g:"🪧"},{key:"stockpile",name:"Stockpile",r:40,i:20,j:["stone","wood"],g:"📦"},{key:"woodCutter",name:"Woodcutter",r:20,i:6,j:["wood"],input:[],l:["wood"],rate:2,g:"🪚"},{key:"stoneMine",name:"Stone Mine",r:20,i:6,j:["wood"],input:[],l:["wood"],rate:2,s:["oreMine"],g:"🪚"},{key:"oreMine",name:"Ore Mine",r:30,i:6,j:["wood"],input:[],l:["ore"],rate:2,g:"🪚"},{key:"tower",name:"Watchtower",r:14,i:2,j:["stone","wood","wood"],N:5,s:["fortress"],g:"🛡️"},{key:"fortress",name:"Fortress",r:24,i:4,j:["stone","stone","stone","stone","wood"],N:8,g:"🛡️"},{key:"grainFarm",name:"Grain farm",r:20,i:10,j:["wood","wood"],input:[],l:["grain"],rate:2,s:["riceFarm"],g:"🪚"},{key:"riceFarm",name:"Rice farm",r:24,i:6,j:["wood"],input:[],l:["rice"],rate:2,g:"🪚"},{key:"shrine",name:"Shrine",r:16,i:6,j:["wood"],input:["rice"],l:["karma"],rate:2,s:["temple"],g:"🪷"},{key:"temple",name:"Temple",r:32,i:6,j:["wood"],input:["rice"],l:["karma","karma"],rate:2,g:"🪷"},{key:"farmHouse",name:"Noka (farmhouse)",r:20,i:6,j:["wood"],input:["grain"],l:["meeple"],rate:10,T:4,s:["urbanHouse"],W:!0,g:"🛖"},{key:"urbanHouse",name:"Machiya (urban house)",r:30,i:6,j:["wood"],input:["rice"],l:["meeple"],rate:1,T:8,W:!0,g:"🛖"}].reduce((e,t)=>(e[t.key]={...ue,...t},e),{}),O=window.pa={state:"game",B:{},h:{},u:[],D:{},v:[],U:{},Z:[],ua:{},ta:[],m:null,V:!1,Y:null,R:0,P:0,X:3e5,S:!1,C:!1,K:!1,zoom:1,start:function(){console.log("hello shikken");var e=Math.max(window.innerHeight,window.innerWidth),t=document.querySelector("#wc"),n=(q(t,{width:e,height:e}),document.querySelector("#w")),r=document.querySelector("#ws");q(r,{viewBox:`0 0 ${e} `+e}),O.B={c:t,H:n,Ba:r,size:e,la:t.getContext("2d"),ba:{ga:document.querySelector("#layer-road"),aa:document.querySelector("#layer-building"),za:document.querySelector("#layer-resource"),fa:document.querySelector("#layer-meeple")},x:0,y:0},A("#jass",`<ul>${I.map(e=>{var t=le[e];return`<li id=jr-${e}><label for="input-${e}">${t.name} <span class="altname">(${t.J})</span> ${t.g}</label><b><span class=jr-num></span></b>
		<input id="input-${e}" type=range min=0></li>`}).join("")}</ul>`),se(O.B),e=c({type:"connector"}),c({type:"connector"},e.key),i(),i(),i(),f()},qa:w,ra:T,va:L,na:K,wa:R};document.addEventListener("DOMContentLoaded",O.start)}();