!function(){function r(e="U"){return[e,j(9999).toString(36),Number(new Date).toString(36)].join("-")}function i(e,t,n={}){var o=e<t;if(e={key:r("R"),from:o?e:t,U:o?t:e,...n},M.I[e.key])throw Error("Existing building");M.I[e.key]=e,M.O.push(e.key)}function l(e={},t=null){if(e={key:r("B"),type:"connector",fa:!0,resources:["wood","stone","wood","grain"],refresh:!1,x:j(1e3),y:j(1e3),...e},M.u[e.key])throw Error("Existing building");return console.log("Adding building",e),M.u[e.key]=e,M.K.push(e.key),t&&i(e.key,t),e}function n(e={}){if(e={key:r("M"),m:"idle",ea:100,X:null,ra:null,W:null,path:[],x:j(1e3),y:j(1e3),...e},M.s[e.key])throw Error("Existing meeple");console.log("Adding meeple",e),M.s[e.key]=e,M.o.push(e.key)}function e(){return B.reduce((e,t)=>({...e,[t]:0}),{})}function a(){return M.o.reduce((e,t)=>(e[(t=M.s[t]).m]=(e[t.m]||0)+1,e),e())}function o(t={}){const n=e(),o=e=>(n[e]||0)<t[e];M.o.forEach(e=>{e=M.s[e],o(e.m)||(e.m=B.find(o)||"idle"),e=e.m,n[e]=(n[e]||0)+1}),console.log("Meeples assigned jobs:",M.s,"desired:",t,"final:",n)}function c(n){B.forEach(e=>{var t=document.querySelector("#jr-"+e);n(e,t.querySelector('[type="range"]'),t)})}function d(){(t=document.querySelector("main").classList).toggle("bselected",M.l),t.toggle("looping",M.D),t.toggle("creating",M.i),t.toggle("assigning",M.A),t.toggle("pop",0<M.o.length),M.G||(M.G=document.getElementById("cd"));var e=M.F,t=Math.floor(1/60*e*.001),e=Math.floor(.001*(e-6e4*t));if(M.G.innerText=t+":"+(e<10?"0":"")+e,M.i&&(document.getElementById("blist").innerHTML=Object.keys(I).map(e=>`<li>${e}</li>`).join("")),M.A){const o=a(),r=M.o.length;c((e,t,n)=>{n.querySelector("b").innerText=o[e],t.setAttribute("max","defe"===e?1:r),t.setAttribute("value",o[e]),t.value=o[e]})}}function u(){var i,e=M.J;e.H.style.top=e.y+"px",e.H.style.left=e.x+"px",i=e.R,M.K.forEach(e=>{var t,n,o=M.u[e],r=document.getElementById(e);r&&o.refresh&&(r.remove(),r=null),r||(t=i.P,r=I[o.type],console.log(o,r),(t=k("g",t)).id=o.key,n=k("circle",t),b(n,{cx:o.x,cy:o.y,r:r.r,L:"building building-"+o.type}),r=t),o.resources.forEach(()=>{}),r.classList.toggle("selectedb",e===M.l)}),M.O.forEach(e=>{var t,n=M.I[e];document.getElementById(e)||((e=k("line",i.T)).id=n.key,t=M.u[n.from],n=M.u[n.U],b(e,{x1:t.x,y1:t.y,x2:n.x,y2:n.y,L:"road"}))}),M.o.forEach(e=>{var t=M.s[e];(e=document.getElementById(e))||((e=k("circle",i.S)).id=t.key,b(e,{cx:0,cy:0,r:7,L:"meeple meeple-"+t.m})),e.style.cx=t.x,e.style.cy=t.y}),d()}function s(){var e,t,n;M.D&&(e=Number(new Date),t=M.C?e-M.C:0,M.C=e,M.F-=t,n=t,M.o.forEach(e=>{var t;"idle"===(e=M.s[e]).m&&(e.x+=(t=.05*n)*(2*(0|x(2))-1),e.y+=t*(2*(0|x(2))-1))}),u(),setTimeout(s,100))}function g(){M.D=!0,M.C=0,s()}function m(){M.D=!1}function y(e){return M.l=e.key,e.type+" : "+e.resources.join(", ")}function f(e){var t=e.target,n=t.classList;let o="";n.contains("building")?(e=M.u[t.closest("g").id],M.i&&M.l&&(i(e.key,M.l),M.i=!1),o=y(e)):M.i&&M.l?(M.i=!1,e=l({x:e.clientX,y:e.clientY,type:"connector"},M.l),o=y(e)):(M.l=null,n.contains("road")&&(o="road")),document.getElementById("binfo").innerHTML=o,u()}function p(){}function h(e){const t=e.target,n={"#play":g,"#pause":m,"#build":()=>M.i=!0,"#cancel":()=>M.i=!1,"#restart":()=>window.location.reload(),"#jobs":()=>M.A=!M.A};Object.keys(n).forEach(e=>{t.closest(e)&&n[e]()}),d()}function E(t){var e=t.H;let n;v(e,"dragstart",e=>{e.dataTransfer.setData("text/plain","w"),e.dataTransfer.effectAllowed="move",n=e}),v(e,"drop",e=>{t.x+=e.clientX-n.clientX,t.y+=e.clientY-n.clientY,u()}),v(document.querySelector("main"),"dragover",e=>{e.preventDefault()}),e.addEventListener("pointerdown",f),v(document.getElementById("bui"),"pointerdown",h),v(document.getElementById("tui"),"pointerdown",p),c((t,n)=>{v(n,"change",()=>{var e=function(o,e){const r=a(),i={...r,[o]:e};if((e=i[o]-r[o])<=0)i.B+=-1*e;else{let n=e;if("idle"!==o&&(e=Math.min(r.B,e),n-=e,i.B-=e),!(n<=0)){const l=B.reduce((e,t)=>(t!==o&&"idle"!==t&&e.push(t),e),[]);l.forEach((e,t)=>{t=Math.min(Math.ceil(n/(l.length-t||1)),r[e]),n-=t,i[e]-=t})}}return i}(t,Number(n.value)||0);console.log("Desiring",e),o(e),d()})})}const v=(e,t,n)=>e.addEventListener(t,n),k=(e,t)=>(e=document.createElementNS("http://www.w3.org/2000/svg",e),t.appendChild(e),e),b=(t,n)=>Object.keys(n).forEach(e=>t.setAttribute(e,n[e])),x=(e=1,t=0)=>t+(e-t)*Math.random(),j=(e=1,t=0)=>0|x(e,t),B=["idle","prod","carr","defe","spir"],I={ha:{r:10,g:19,h:["wood","wood","stone","stone"],M:2,N:10},Y:{r:10,g:4,h:["stone"],v:"stoneMine grainFarm tower shrine farmHouse woodCutter stockpile".split(" ")},la:{r:30,g:20,h:["stone","wood"]},sa:{r:10,g:6,h:["wood"],input:[],j:["wood"],rate:2},ma:{r:10,g:6,h:["wood"],input:[],j:["wood"],rate:2,v:["oreMine"]},ga:{r:10,g:6,h:["wood"],input:[],j:["ore"],rate:2},pa:{r:14,g:2,h:["stone","wood","wood"],M:5,v:["fortress"]},aa:{r:20,g:4,h:["stone","stone","stone","stone","wood"],M:8},da:{r:20,g:10,h:["wood","wood"],input:[],j:["grain"],rate:2,v:["riceFarm"]},ja:{r:10,g:6,h:["wood"],input:[],j:["rice"],rate:2},ka:{r:10,g:6,h:["wood"],input:["rice"],j:["karma"],rate:2,v:["temple"]},oa:{r:10,g:6,h:["wood"],input:["rice"],j:["karma","karma"]},$:{r:10,g:6,h:["wood"],input:["grain"],j:["meeple"],N:4,v:["urbanHouse"]},qa:{r:10,g:6,h:["wood"],input:["rice"],j:["meeple"],N:8}},M=window.ba={state:"game",J:{},u:{},K:[],s:{},o:[],I:{},O:[],l:null,G:null,C:0,F:3e5,D:!1,i:!1,A:!1,start:function(){console.log("hello shikken");var e=document.getElementById("wc"),t=document.getElementById("w");M.J={c:e,H:t,na:document.getElementById("ws"),Z:e.getContext("2d"),R:{T:document.getElementById("layer-road"),P:document.getElementById("layer-building"),ia:document.getElementById("layer-resource"),S:document.getElementById("layer-meeple")},x:0,y:0},E(M.J),e=l({type:"connector"}),l({type:"connector"},e.key),n(),n(),n(),u(w)},ca:a,V:o};document.addEventListener("DOMContentLoaded",M.start)}();