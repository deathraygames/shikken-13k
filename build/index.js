!function(){function r(e="U"){return[e,I(9999).toString(36),Number(new Date).toString(36)].join("-")}function a(e,t,n={}){var o=e<t;if(e={key:r("R"),from:o?e:t,V:o?t:e,...n},N.N[e.key])throw Error("Existing building");N.N[e.key]=e,N.S.push(e.key)}function o(e,t=0){var n=L[e.type]["rate"];n?(t=Number.isNaN(t)?0:t,e.A=1/n*6e4+t):e.A=0}function i(e={},t=null){if(o(e={key:r("B"),type:"connector",A:0,ga:!0,resources:["wood","stone","wood","grain"],refresh:!1,x:I(1e3),y:I(1e3),...e}),N.i[e.key])throw Error("Existing building");return console.log("Adding building",e),N.i[e.key]=e,N.B.push(e.key),t&&a(e.key,t),e}function n(e={}){if(N.s.length>=1+N.B.reduce((e,t)=>e+(N.i[t].M||0),0))console.warn("Could not add another meeple");else{if(e={key:r("M"),o:"idle",fa:100,Y:null,sa:null,X:null,path:[],x:I(1e3),y:I(1e3),...e},N.u[e.key])throw Error("Existing meeple");console.log("Adding meeple",e),N.u[e.key]=e,N.s.push(e.key)}}function e(){return S.reduce((e,t)=>({...e,[t]:0}),{})}function l(){return N.s.reduce((e,t)=>(e[(t=N.u[t]).o]=(e[t.o]||0)+1,e),e())}function c(t={}){const n=e(),o=e=>(n[e]||0)<t[e];N.s.forEach(e=>{e=N.u[e],o(e.o)||(e.o=S.find(o)||"idle"),e=e.o,n[e]=(n[e]||0)+1}),console.log("Meeples assigned jobs:",N.u,"desired:",t,"final:",n)}function u(){const a=N.H.R;N.B.forEach(e=>{var t,n,o=N.i[e],r=document.getElementById(e);r&&o.refresh&&(r.remove(),r=null,o.refresh=!1),r||(r=L[o.type],(t=x("g",a.O)).id=o.key,n=x("circle",t),j(n,{cx:o.x,cy:o.y,r:r.r,P:"building b-"+o.type}),r=t),o.resources.forEach(()=>{}),r.classList.toggle("selectedb",e===N.j)})}function s(n){S.forEach(e=>{var t=document.querySelector("#jr-"+e);n(e,t.querySelector('input[type="range"]'),t,t.querySelector("b"))})}function d(){var r,a,i;N.C&&(r=l(),a=N.s.length,i=Math.min(a,N.B.reduce((e,t)=>e+(N.i[t].K||0),0)),s((e,t,n,o)=>{n=r[e],o.innerText=n,t.max!==(e="defe"===e?i:a)&&(t.setAttribute("max",e),t.max=e),t.value!==n&&(t.setAttribute("value",n),t.value=n)}))}function t(){(t=document.querySelector("main").classList).toggle("bselected",N.j),t.toggle("looping",N.G),t.toggle("creating",N.m),t.toggle("assigning",N.C),t.toggle("pop",0<N.s.length),N.J||(N.J=document.getElementById("cd"));var e=N.I,t=Math.floor(1/60*e*.001),e=Math.floor(.001*(e-6e4*t));N.J.innerText=t+":"+(e<10?"0":"")+e,N.j&&(t=L[N.i[N.j].type]["v"],M("#blist",t?t.map(e=>{var{name:t=e,g:n}=L[e];return`<li class=up-action data-upgrade="${e}" data-building="${N.j}">
						<span class=up-name>${t}</span>
						<span class=up-cost>${n}</span>
					</li>`}).join(""):"No upgrades"))}function m(){var o,e=N.H;e.L.style.top=e.y+"px",e.L.style.left=e.x+"px",o=e.R,u(),N.S.forEach(e=>{var t,n=N.N[e];document.getElementById(e)||((e=x("line",o.U)).id=n.key,t=N.i[n.from],n=N.i[n.V],j(e,{x1:t.x,y1:t.y,x2:n.x,y2:n.y,P:"road"}))}),N.s.forEach(e=>{var t=N.u[e];(e=document.getElementById(e))||((e=x("circle",o.T)).id=t.key,j(e,{cx:0,cy:0,r:7,P:"meeple mj-"+t.o})),e.setAttribute("class","meeple mj-"+t.o),e.style.cx=t.x,e.style.cy=t.y}),t()}function g(){var e,t,n;N.G&&(e=Number(new Date),t=N.F?e-N.F:0,N.F=e,N.I-=t,n=t,N.s.forEach(e=>{var t;"idle"===(e=N.u[e]).o&&(e.x+=(t=.05*n)*(2*(0|B(2))-1),e.y+=t*(2*(0|B(2))-1))}),N.B.forEach(e=>{e=N.i[e];var t=L[e.type];(t.l||t.input)&&(e.A-=n,0<e.A||o(e,e.A))}),m(),setTimeout(g,100))}function p(){N.G=!0,N.F=0,g()}function y(){N.G=!1}function f(e){return N.j=e.key,`${L[e.type].name||e.type} : `+e.resources.join(", ")}function h(e){var t=e.target,n=t.classList;let o="";n.contains("building")?(e=N.i[t.closest("g").id],N.m&&N.j&&(a(e.key,N.j),N.m=!1),o=f(e)):N.m&&N.j?(N.m=!1,e=i({x:e.clientX,y:e.clientY,type:"connector"},N.j),o=f(e)):(N.j=null,n.contains("road")&&(o="road")),M("#binfo",o),m()}function w(n,o={}){const r=n.target;Object.keys(o).forEach(e=>{var t=r.closest(e);t&&o[e](n,t)}),t()}function v(e){w(e,{".up-action":(e,t)=>{e=t.dataset.upgrade,t=N.i[t.dataset.O];var{v:n=[]}=L[t.type];if(!n.includes(e))throw Error("Unknown upTypeKey");t.type=e,t.refresh=!0,o(t),u(),N.m=!1}})}function E(e){w(e,{"#play":p,"#pause":y,"#build":()=>N.m=!0,"#cancel":()=>N.m=!1,"#restart":()=>window.location.reload(),"#jobs":()=>{N.C=!N.C,d()}})}function b(t){var e=t.L;let n;k(e,"dragstart",e=>{e.dataTransfer.setData("text/plain","w"),e.dataTransfer.effectAllowed="move",n=e}),k(e,"drop",e=>{t.x+=e.clientX-n.clientX,t.y+=e.clientY-n.clientY,m()}),k(document.querySelector("main"),"dragover",e=>{e.preventDefault()}),e.addEventListener("pointerdown",h),k(document.getElementById("bui"),"pointerdown",E),k(document.getElementById("tui"),"pointerdown",v),s((t,n)=>{k(n,"change",()=>{var e=function(o,e){const r=l(),a={...r,[o]:e};if((e=a[o]-r[o])<=0)a.D+=-1*e;else{let n=e;if("idle"!==o&&(e=Math.min(r.D,e),n-=e,a.D-=e),!(n<=0)){const i=S.reduce((e,t)=>(t!==o&&"idle"!==t&&e.push(t),e),[]);i.forEach((e,t)=>{t=Math.min(Math.ceil(n/(i.length-t||1)),r[e]),n-=t,a[e]-=t})}}return a}(t,Number(n.value)||0);console.log("Desiring",e),c(e),d(),m()})})}const k=(e,t,n)=>e.addEventListener(t,n),x=(e,t)=>(e=document.createElementNS("http://www.w3.org/2000/svg",e),t.appendChild(e),e),j=(t,n)=>Object.keys(n).forEach(e=>t.setAttribute(e,n[e])),M=(e,t)=>(e=document.querySelector(e)).innerHTML!==t&&(e.innerHTML=t,!0),B=(e=1,t=0)=>t+(e-t)*Math.random(),I=(e=1,t=0)=>0|B(e,t),S=["idle","prod","carr","defe","spir"],A=["Wanderer (Idle)","Farmer/Artisan (Production)","Peasant (Carrying)","Samurai (Defenders)","Monk/Pilgrim (Spiritualist)"],L={ia:{name:"Outpost",r:20,h:19,g:["wood","wood","stone","stone"],K:2,M:10},Z:{r:10,h:4,g:["stone"],v:"stoneMine grainFarm tower shrine farmHouse woodCutter stockpile".split(" ")},ma:{name:"Stockpile",r:40,h:20,g:["stone","wood"]},ta:{name:"Woodcutter",r:20,h:6,g:["wood"],input:[],l:["wood"],rate:2},na:{name:"Stone Mine",r:20,h:6,g:["wood"],input:[],l:["wood"],rate:2,v:["oreMine"]},ha:{name:"Ore Mine",r:30,h:6,g:["wood"],input:[],l:["ore"],rate:2},qa:{name:"Watchtower",r:14,h:2,g:["stone","wood","wood"],K:5,v:["fortress"]},ba:{name:"Fortress",r:24,h:4,g:["stone","stone","stone","stone","wood"],K:8},ea:{name:"Grain farm",r:20,h:10,g:["wood","wood"],input:[],l:["grain"],rate:2,v:["riceFarm"]},ka:{name:"Rice farm",r:24,h:6,g:["wood"],input:[],l:["rice"],rate:2},la:{name:"Shrine",r:16,h:6,g:["wood"],input:["rice"],l:["karma"],rate:2,v:["temple"]},pa:{name:"Temple",r:32,h:6,g:["wood"],input:["rice"],l:["karma","karma"],rate:2},aa:{name:"Noka (farmhouse)",r:20,h:6,g:["wood"],input:["grain"],l:["meeple"],rate:1,M:4,v:["urbanHouse"]},ra:{name:"Machiya (urban house)",r:30,h:6,g:["wood"],input:["rice"],l:["meeple"],rate:1,M:8}},N=window.ca={state:"game",H:{},i:{},B:[],u:{},s:[],N:{},S:[],j:null,J:null,F:0,I:3e5,G:!1,m:!1,C:!1,start:function(){console.log("hello shikken");var e=document.getElementById("wc"),t=document.getElementById("w");N.H={c:e,L:t,oa:document.getElementById("ws"),$:e.getContext("2d"),R:{U:document.getElementById("layer-road"),O:document.getElementById("layer-building"),ja:document.getElementById("layer-resource"),T:document.getElementById("layer-meeple")},x:0,y:0},M("#jass",`<ul>${S.map((e,t)=>`<li id=jr-${e}><label for="input-${e}">${A[t]}</label><b></b>
		<input id="input-${e}" type=range min=0></li>`).join("")}</ul>`),b(N.H),e=i({type:"connector"}),i({type:"connector"},e.key),n(),n(),n(),m()},da:l,W:c};document.addEventListener("DOMContentLoaded",N.start)}();